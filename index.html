<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gods Plan | Adherencia</title>
    
    <!-- FAVICON -->
    <link rel="shortcut icon" href="./favicon.ico?v=2" type="image/x-icon">
    <link rel="icon" href="./favicon.ico?v=2" type="image/x-icon">

    <!-- FUENTE UNIFICADA: PLUS JAKARTA SANS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- SCRIPT DE ICONOS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- TAILWIND CSS & CONFIGURACIÓN DE TEMA -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg)',
                        card: 'var(--card)',
                        text: 'var(--text)',
                        'text-mute': 'var(--text-mute)',
                        brand: 'var(--brand)',
                        'login-brand': 'var(--login-brand)',
                        money: 'var(--money)',
                        alert: 'var(--alert)',
                        warn: 'var(--warn)',
                        border: 'var(--border)',
                        'input-bg': 'var(--input-bg)',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'nebula': 'nebula 20s infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        nebula: { '0%': { transform: 'scale(1)', opacity: '0.3' }, '100%': { transform: 'scale(1.2)', opacity: '0.6' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { from: { opacity: 0, transform: 'translateY(-5px)' }, to: { opacity: 1, transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg: #000000;
            --card: #111111;
            --border: #262626;
            --input-bg: #0a0a0a;
            --text: #e5e5e5;
            --text-mute: #737373;
            --brand: #dc2626;
            --login-brand: #E70000;
            --money: #16a34a;
            --alert: #b91c1c;
            --warn: #d97706;
            --header-bg: rgba(0, 0, 0, 0.9);
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { border: 4px solid var(--border); border-top: 4px solid var(--brand); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }

        .aurora-bg {
            position: fixed; inset: 0; z-index: -2;
            background: radial-gradient(circle at 50% 50%, rgba(50, 0, 0, 0.4) 0%, transparent 60%),
                        radial-gradient(circle at 80% 20%, rgba(231, 0, 0, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 20% 80%, rgba(100, 0, 0, 0.2) 0%, transparent 40%);
            filter: blur(80px);
            pointer-events: none;
        }

        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            pointer-events: none;
        }

        .input-gp {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; padding: 14px 16px; border-radius: 16px;
            font-size: 0.95rem; font-weight: 500;
        }
        .input-gp:focus { border-color: var(--login-brand); outline: none; background: rgba(231,0,0,0.05); box-shadow: 0 0 20px rgba(231,0,0,0.2); transform: translateY(-2px); }
        .input-gp::placeholder { color: rgba(255,255,255,0.3); }

        .glass-panel {
            background: rgba(15, 15, 15, 0.6); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .auth-switch { position: relative; display: flex; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 4px; margin-bottom: 24px; }
        .auth-switch button { flex: 1; padding: 8px; font-size: 0.8rem; font-weight: 700; z-index: 1; color: #666; transition: 0.3s; }
        .auth-switch button.active { color: white; }
        .auth-switch-glider {
            position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); width: calc(50% - 4px);
            background: #222; border-radius: 8px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.1);
        }
        .auth-mode-register .auth-switch-glider { transform: translateX(100%); }

        .btn-glow { position: relative; overflow: hidden; background: var(--login-brand); color: white; transition: all 0.3s; }
        .btn-glow:hover { box-shadow: 0 0 30px rgba(231, 0, 0, 0.4); transform: translateY(-2px); }

        .g-link.active { color: #fff; border-bottom: 2px solid #fff; padding-bottom: 2px; }
        .btn-ctrl.active-bath { background: var(--card); color: var(--brand) !important; border-color: var(--brand) !important; box-shadow: inset 0 0 0 1px var(--brand); }
        .btn-ctrl.active-food { background: var(--card); color: var(--warn) !important; border-color: var(--warn) !important; box-shadow: inset 0 0 0 1px var(--warn); }
        .btn-ctrl.active-pause { background: #451a03; color: #fb923c !important; border-color: #fb923c !important; box-shadow: inset 0 0 0 1px #f97316; }
        .side-clock.active { opacity: 1; transform: scale(1.05); background: transparent; }
        .side-clock.danger .side-val { color: var(--alert) !important; }
        .tab { @apply text-text-mute rounded-md transition-all; }
        .tab.active { @apply bg-white/10 text-white shadow-sm ring-1 ring-white/10 font-bold; }
        input, select, textarea { color: var(--text) !important; }
    </style>
</head>

<body class="bg-bg text-text font-sans selection:bg-brand selection:text-white min-h-screen">

    <div class="aurora-bg"></div>
    <div class="grid-bg"></div>

    <!-- LOGIN / REGISTER -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-[#030000]">
        <div class="absolute top-8 left-8 flex items-center gap-3 animate-fade-in opacity-50">
             <div class="relative w-8 h-8 flex items-center justify-center"><i class="ph-fill ph-planet text-2xl text-brand"></i></div>
            <span class="font-bold tracking-widest text-lg">GOD'S PLAN</span>
        </div>
        <div class="w-full max-w-md animate-float">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-2">GOD'S PLAN</h1>
                <p class="text-zinc-500 text-sm font-mono tracking-widest uppercase">Portal de Acceso Centralizado</p>
            </div>
            <div class="glass-panel rounded-3xl p-8 relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-brand blur-md opacity-50"></div>
                <div class="auth-switch" id="auth-switch-container">
                    <div class="auth-switch-glider"></div>
                    <button onclick="window.app.toggleAuth('login')" id="tab-login" class="active">INGRESAR</button>
                    <button onclick="window.app.toggleAuth('register')" id="tab-register">REGISTRARSE</button>
                </div>
                <form onsubmit="event.preventDefault(); window.app.handleAuthSubmit();" class="flex flex-col gap-5">
                    <div id="field-name" class="hidden transition-all duration-300">
                        <div class="relative group">
                            <i class="ph-bold ph-user absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                            <input type="text" id="input-name" class="input-gp pl-12" placeholder="Tu Nombre">
                        </div>
                    </div>
                    <div class="relative group">
                        <i class="ph-bold ph-identification-card absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                        <input type="text" id="input-id" class="input-gp pl-12" placeholder="ID (Ej: 17620) o Email" required>
                    </div>
                    <div class="relative group">
                        <i class="ph-bold ph-lock-key absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                        <input type="password" id="input-pass" class="input-gp pl-12" placeholder="Contraseña Maestra" required>
                    </div>
                    <div id="auth-error-msg" class="hidden p-3 bg-red-500/10 border border-red-500/20 rounded-xl text-red-400 text-xs font-bold text-center flex items-center justify-center gap-2">
                        <i class="ph-fill ph-warning-circle"></i> <span id="auth-error-txt">Error</span>
                    </div>
                    <button type="submit" id="btn-submit" class="btn-glow w-full py-4 rounded-xl font-black uppercase tracking-widest text-sm mt-2 flex items-center justify-center gap-2 group cursor-pointer">
                        <span id="btn-text">INICIAR SESIÓN</span> <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </form>
                <div class="relative my-6 text-center">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                    <span class="relative bg-[#0a0a0a] px-2 text-[10px] text-zinc-600 font-bold uppercase tracking-widest">O accede con</span>
                </div>
                <button onclick="window.app.loginGoogle()" class="w-full bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-3 group cursor-pointer">
                    <i class="ph-bold ph-google-logo text-xl group-hover:text-brand transition-colors"></i> <span>Google Account</span>
                </button>
            </div>
        </div>
        <footer class="absolute bottom-4 left-0 w-full text-center pointer-events-none opacity-30">
            <p class="text-[10px] font-mono tracking-[0.5em] text-white">SYSTEM v2.0 // SECURE</p>
        </footer>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-view" class="hidden min-h-screen pb-24 pt-20">
        <header class="bg-card border-b border-border py-2.5 px-4 fixed top-0 left-0 w-full z-50 flex justify-between items-center shadow-sm flex-wrap gap-2.5 transition-all">
            <div class="text-[1.1rem] font-extrabold flex items-center gap-2 text-text uppercase">
                <i class="ph-fill ph-check-circle text-brand"></i> <span>Panel de Control</span>
            </div>
            <div class="flex items-center gap-2 flex-wrap justify-end flex-1 md:flex-none">
                <div id="realWorldClock" class="flex flex-col items-end mr-1 px-2 py-0.5 border-r border-border/50 min-w-[70px]">
                    <div class="text-[0.6rem] text-text-mute font-black tracking-wider leading-none mb-0.5 flex items-center gap-1 justify-end">
                          <span id="syncDot" class="w-1.5 h-1.5 rounded-full bg-red-500 inline-block transition-colors duration-300"></span> CDMX
                    </div>
                    <div class="text-[0.9rem] font-mono font-bold text-text leading-none tabular-nums text-right" id="realClockTime">--:--:--</div>
                </div>
                <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg hover:text-text cursor-pointer" onclick="window.app.syncData()" title="Sincronizar"><i class="ph-bold ph-arrows-clockwise"></i></button>
                <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg hover:text-text cursor-pointer" onclick="window.app.openConfigModal()" title="Menú"><i class="ph-bold ph-gear"></i></button>
                <div class="flex items-center gap-1 bg-bg px-2 py-1 rounded-full border border-border">
                    <button class="bg-transparent border-none text-text-mute cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:text-text" onclick="window.app.changeMonth(-1)"><i class="ph-bold ph-caret-left"></i></button>
                    <span class="text-[0.85rem] font-extrabold uppercase text-text min-w-[75px] text-center" id="monthLabel">--</span>
                    <button class="bg-transparent border-none text-text-mute cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:text-text" onclick="window.app.changeMonth(1)"><i class="ph-bold ph-caret-right"></i></button>
                    <button class="bg-transparent border-none text-brand cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:scale-110 transition-transform" onclick="window.app.goToday()"><i class="ph-bold ph-calendar-check"></i></button>
                </div>
            </div>
        </header>

        <div class="w-full max-w-[900px] mx-auto p-4 overflow-x-hidden">
            <!-- RELOJ PRINCIPAL -->
            <div class="bg-card rounded-2xl border border-border py-5 px-2.5 text-center mb-5 shadow-sm relative overflow-hidden">
                <div id="mainLoader" class="absolute inset-0 bg-card/90 flex items-center justify-center z-10 rounded-2xl hidden">
                    <div class="spinner"></div>
                </div>
                <div class="grid grid-cols-[1fr_1.2fr_1fr] items-center gap-1.5 mb-5" id="timersDisplay" style="display:none;">
                    <button class="side-clock flex flex-col items-center justify-center opacity-50 p-1.5 rounded-lg relative z-10 w-full h-full border-none hover:bg-bg hover:opacity-100 hover:scale-105 transition-all cursor-pointer" id="clockBathContainer" onclick="window.app.openTimerEdit('bathroom')" type="button">
                        <div class="text-[0.65rem] font-extrabold uppercase text-text-mute mb-1 flex items-center justify-center gap-1">
                            <i class="ph-bold ph-toilet"></i> Baño <i class="ph-bold ph-pencil-simple text-brand text-[0.9em]"></i>
                        </div>
                        <div class="font-mono font-bold text-base text-text tabular-nums" id="dispBath">00:00</div>
                        <div class="text-[0.65rem] text-text-mute mt-0.5">/ <span id="limBath">15</span>m</div>
                        <div id="remBath" class="text-[0.7rem] font-extrabold mt-1 text-money">Restan: --</div>
                    </button>
                    
                    <div class="flex flex-col items-center">
                        <div class="text-[0.7rem] uppercase tracking-widest text-text-mute font-extrabold mb-1.5" id="clockStatus">TURNO ACTIVO</div>
                        <div class="text-[clamp(2.5rem,12vw,4rem)] font-extrabold text-text tabular-nums leading-none" id="clockDisplay">00:00</div>
                        <div id="shiftStartTime" class="text-[0.7rem] text-text-mute font-bold mt-1.5 uppercase tracking-wide opacity-80" style="display:none;">ENTRADA: --:--</div>
                        <div id="networkTimeBadge" class="text-[0.65rem] text-money font-bold mt-1.5 opacity-0 transition-opacity duration-500"><i class="ph-bold ph-globe"></i> Local</div>
                    </div>

                    <button class="side-clock flex flex-col items-center justify-center opacity-50 p-1.5 rounded-lg relative z-10 w-full h-full border-none hover:bg-bg hover:opacity-100 hover:scale-105 transition-all cursor-pointer" id="clockFoodContainer" onclick="window.app.openTimerEdit('food')" type="button">
                        <div class="text-[0.65rem] font-extrabold uppercase text-text-mute mb-1 flex items-center justify-center gap-1">
                            <i class="ph-bold ph-hamburger"></i> Comida <i class="ph-bold ph-pencil-simple text-brand text-[0.9em]"></i>
                        </div>
                        <div class="font-mono font-bold text-base text-text tabular-nums" id="dispFood">00:00</div>
                        <div class="text-[0.65rem] text-text-mute mt-0.5">/ <span id="limFood">45</span>m</div>
                        <div id="remFood" class="text-[0.7rem] font-extrabold mt-1 text-money">Restan: --</div>
                    </button>
                </div>
                <div id="offlineDisplay" style="display:block;">
                    <div class="text-[0.7rem] uppercase tracking-widest text-text-mute font-extrabold mb-2.5">FUERA DE TURNO</div>
                    <div class="text-[clamp(2.5rem,12vw,4rem)] font-extrabold text-text-mute tabular-nums leading-none mb-5">--:--:--</div>
                </div>
                <div class="grid grid-cols-2 gap-2.5 mt-4" id="actionButtons"></div>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-card border border-border rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2.5 pb-2 border-b border-border">
                        <div class="flex items-center gap-2">
                            <button class="bg-transparent border-none text-brand cursor-pointer text-base p-0 hover:text-white" onclick="window.app.changeWeek(-1)"><i class="ph-bold ph-caret-left"></i></button>
                            <span class="text-[0.9rem] font-extrabold text-text">Semana <span id="weekNum">--</span></span>
                            <button class="bg-transparent border-none text-brand cursor-pointer text-base p-0 hover:text-white" onclick="window.app.changeWeek(1)"><i class="ph-bold ph-caret-right"></i></button>
                        </div>
                        <span id="weekBalance" class="px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] bg-emerald-900/30 text-emerald-400">0h</span>
                    </div>
                    <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Meta</span><strong id="weekTarget" class="text-text">0:00</strong></div>
                    <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Trabajado</span><strong class="text-brand" id="weekWorked">0:00</strong></div>
                    <div class="flex justify-between items-center mt-2.5 pt-1.5 border-t border-dashed border-border text-[0.9rem]">
                        <span class="text-text-mute">Pago Extra</span><strong class="text-money" id="weekPay">$0</strong>
                    </div>
                </div>

                <div class="bg-card border border-border rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2.5 pb-2 border-b border-border">
                        <span class="text-[0.9rem] font-extrabold text-text">Quincena <span id="qName">--</span></span>
                        <span id="qBalance" class="px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] bg-emerald-900/30 text-emerald-400">0h</span>
                    </div>
                    <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Meta</span><strong id="qTarget" class="text-text">0:00</strong></div>
                    <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Trabajado</span><strong class="text-brand" id="qWorked">0:00</strong></div>
                    <div class="flex justify-between items-center mt-2.5 text-[0.9rem]"><span class="text-alert">Faltas</span><strong class="text-alert" id="qFails">0</strong></div>
                </div>
            </div>

            <!-- LISTA HISTORIAL -->
            <div class="bg-card border border-border rounded-2xl overflow-hidden shadow-sm mb-6">
                <div class="px-5 py-4 bg-bg/50 font-extrabold text-text-mute text-[0.75rem] border-b border-border flex justify-between items-center tracking-wide">
                    <span id="logListTitle">HISTORIAL</span>
                    <button onclick="window.app.openModal()" class="border-none bg-transparent text-brand font-extrabold cursor-pointer hover:underline">+ MANUAL</button>
                </div>
                <div id="logList"></div>
            </div>
        </div>
    </div>

    <!-- BOTÓN SCROLL TO TOP -->
    <button id="scrollTopBtn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="fixed bottom-6 left-6 w-11 h-11 rounded-full bg-brand text-white shadow-lg shadow-brand/20 border border-white/10 z-50 flex items-center justify-center translate-y-20 opacity-0 transition-all duration-300 hover:scale-110 cursor-pointer">
        <i class="ph-bold ph-arrow-up text-xl"></i>
    </button>

    <!-- MODALES -->
    <div class="modal fixed inset-0 w-screen h-screen z-[1000] hidden bg-black/80 backdrop-blur-sm" id="navModal" onclick="window.app.toggleModal('navModal', false)">
        <div class="absolute bottom-0 left-0 w-full bg-card rounded-t-2xl p-6 border-t border-border animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <span class="font-bold text-lg text-text">Navegación</span>
                 <button onclick="window.app.toggleModal('navModal', false)" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 text-text-mute hover:text-text cursor-pointer"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
        </div>
    </div>
    
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="configModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[400px] max-h-[90vh] overflow-hidden flex flex-col border border-border shadow-2xl relative">
            <div class="p-4 border-b border-border flex justify-between items-center bg-bg/50 backdrop-blur-sm sticky top-0 z-10">
                <div class="flex items-center gap-2"> <i class="ph-fill ph-planet text-xl text-brand"></i> <span class="font-bold text-text text-sm tracking-wide">CONFIGURACIÓN</span> </div>
                <button onclick="window.app.toggleModal('configModal', false)" class="text-text-mute hover:text-text transition-colors cursor-pointer"> <i class="ph-bold ph-x text-lg"></i> </button>
            </div>
            <div class="p-5 overflow-y-auto flex-1">
                <div class="flex p-1 bg-input-bg rounded-xl mb-6 border border-border/50">
                    <div class="tab active flex-1 text-center py-2 text-[0.75rem] font-bold cursor-pointer hover:text-text" onclick="window.app.switchTab('tSettings')">Ajustes</div>
                    <div class="tab flex-1 text-center py-2 text-[0.75rem] font-bold cursor-pointer hover:text-text" onclick="window.app.switchTab('tData')">Datos</div>
                </div>
                <div id="tSettings" class="tab-content active block animate-fade-in">
                    <div class="mb-6">
                        <p class="text-[0.65rem] font-black text-brand mb-3 uppercase tracking-wider flex items-center gap-1"><i class="ph-bold ph-clock"></i> Límites (Min)</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-input-bg p-3 rounded-xl border border-border"><label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Baño</label><input type="number" id="cfgBath" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none"></div>
                            <div class="bg-input-bg p-3 rounded-xl border border-border"><label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Comida</label><input type="number" id="cfgFood" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none"></div>
                        </div>
                    </div>
                    <div>
                        <p class="text-[0.65rem] font-black text-money mb-3 uppercase tracking-wider flex items-center gap-1"><i class="ph-bold ph-currency-dollar"></i> Pagos</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-input-bg p-3 rounded-xl border border-border"><label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Base</label><input type="number" id="cfgRate1" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none"></div>
                            <div class="bg-input-bg p-3 rounded-xl border border-border"><label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Extra</label><input type="number" id="cfgRate2" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none"></div>
                        </div>
                    </div>
                </div>
                <div id="tData" class="tab-content hidden animate-fade-in">
                    <div class="space-y-3">
                        <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="window.app.toggleModal('importModal', true)">
                            <div class="w-10 h-10 rounded-lg bg-emerald-900/30 text-emerald-400 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="ph-bold ph-file-csv text-xl"></i></div>
                            <div><div class="text-sm text-text">Importar Excel</div></div>
                        </button>
                        <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="window.app.exportBackup()">
                             <div class="w-10 h-10 rounded-lg bg-blue-900/30 text-blue-400 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="ph-bold ph-download-simple text-xl"></i></div>
                            <div><div class="text-sm text-text">Descargar Backup</div></div>
                        </button>
                          <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="document.getElementById('importJsonInput').click()">
                            <div class="w-10 h-10 rounded-lg bg-violet-900/30 text-violet-400 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="ph-bold ph-upload-simple text-xl"></i></div>
                            <div><div class="text-sm text-text">Importar JSON</div></div>
                        </button>
                        <input type="file" id="importJsonInput" accept=".json" class="hidden" onchange="window.app.importJson(this)">
                    </div>
                    <div class="border-t border-border my-6"></div>
                    <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-red-900 bg-red-900/10 text-red-500 hover:bg-red-900/20 transition-colors flex items-center justify-center gap-2" onclick="window.app.resetData()"><i class="ph-bold ph-trash"></i> Reiniciar</button>
                </div>
            </div>
             <div class="p-4 border-t border-border bg-card">
                <button class="w-full bg-brand text-white p-3.5 rounded-xl font-extrabold cursor-pointer border-none hover:bg-blue-600 transition-colors shadow-lg shadow-brand/20" onclick="window.app.saveConfig()">GUARDAR CAMBIOS</button>
            </div>
        </div>
    </div>

    <!-- LOG MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="logModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Registro Manual</h3>
            <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Fecha</label>
            <input type="date" id="inpDate" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text mb-2.5 [color-scheme:dark]">
            <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Tipo</label>
            <select id="inpType" onchange="window.app.toggleTimeInputs()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text mb-2.5">
                <option value="Laboral">Laboral</option>
                <option value="Descanso">Descanso</option>
                <option value="Falta">Falta</option>
                <option value="Vacaciones">Vacaciones</option>
            </select>
            <div id="timeInputs">
                <div class="grid grid-cols-2 gap-2.5 mb-2.5">
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Entrada</label><input type="time" id="inpIn" onchange="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text [color-scheme:dark]"></div>
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Salida</label><input type="time" id="inpOut" onchange="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text [color-scheme:dark]"></div>
                </div>
                <div class="bg-bg/50 p-2.5 rounded-lg mb-2.5 border border-border">
                    <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Minutos Reales:</label>
                    <div class="grid grid-cols-3 gap-1.5">
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Baño</label><input type="number" id="inpBathTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Comida</label><input type="number" id="inpFoodTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Pausa</label><input type="number" id="inpPauseTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                    </div>
                </div>
                <p class="text-right text-text-mute text-sm">Neto: <strong id="calcHoursDisplay" class="text-text">0:00</strong></p>
            </div>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-brand text-white hover:bg-blue-600 transition-colors mt-4" onclick="window.app.saveLog()">Guardar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer mb-2.5 text-alert border border-alert bg-transparent hidden hover:bg-alert/10" id="btnDelete" onclick="window.app.deleteLog()">Eliminar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.toggleModal('logModal', false)">Cancelar</button>
        </div>
    </div>

    <!-- CLOCK OUT MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="clockOutModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border text-center">
            <h3 class="text-text font-bold text-lg mb-4">¿Terminar Turno?</h3>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-alert text-white mt-4 mb-2.5 hover:bg-red-600 transition-colors" onclick="window.app.finishShiftReal()">TERMINAR</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.toggleModal('clockOutModal', false)">Cancelar</button>
        </div>
    </div>

    <!-- EDITAR TIEMPO MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="timerEditModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Ajustar Tiempo</h3>
            <p class="text-sm mb-2.5 text-text-mute">Ingresa el tiempo acumulado para <strong id="timerEditTitle" class="text-text">--</strong>.</p>
            <input type="text" id="inpTimerEdit" placeholder="Ej. 3:14" class="text-lg text-center bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text">
            <div class="flex gap-2.5 mt-4">
                <button class="flex-1 bg-brand text-white p-3 rounded-lg font-extrabold cursor-pointer border-none hover:bg-blue-600 transition-colors" onclick="window.app.saveTimerEdit()">Actualizar</button>
                <button class="flex-1 bg-transparent border border-border text-text-mute p-3 rounded-lg font-extrabold cursor-pointer hover:text-text hover:bg-white/5" onclick="window.app.toggleModal('timerEditModal', false)">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- UTILS MODALS -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="msgModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border text-center">
            <i id="msgIcon" class="text-[2.5rem] mb-2.5 block"></i>
            <p id="msgText" class="font-bold mb-5 text-text"></p>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-brand text-white hover:bg-blue-600 transition-colors" onclick="window.app.toggleModal('msgModal', false)">OK</button>
        </div>
    </div>
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="importModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Importar Excel</h3>
            <textarea id="importTextArea" rows="6" class="font-mono text-xs w-full bg-input-bg border border-border p-2.5 rounded-lg text-text mb-4 placeholder-zinc-700" placeholder="Pegar CSV aquí..."></textarea>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-brand text-white hover:bg-blue-600 transition-colors" onclick="window.app.processImport()">Procesar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.toggleModal('importModal', false)">Cancelar</button>
        </div>
    </div>

    <!-- LÓGICA OPTIMIZADA (SINGLE MODULE) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 1. Configuración Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC-cUzYmh5G9y_W2RXbO1Uma4DlKKmnnss",
            authDomain: "odsplan-adherencia.firebaseapp.com",
            projectId: "godsplan-adherencia",
            storageBucket: "godsplan-adherencia.firebasestorage.app",
            messagingSenderId: "660801277434",
            appId: "1:660801277434:web:3a37ece56538dc2b22a843"
        };

        // 2. Inicialización de Servicios
        let auth, db;
        try {
            const fbApp = initializeApp(firebaseConfig);
            auth = getAuth(fbApp);
            db = getFirestore(fbApp);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // Variable global para almacenar el 'unsubscribe' del listener
        let unsubscribeListener = null;

        // 3. Sistema de Caché del DOM (OPTIMIZACIÓN CRÍTICA)
        const elmCache = new Map();
        const getElement = (id) => {
            if (!elmCache.has(id)) {
                const el = document.getElementById(id);
                if (el) elmCache.set(id, el);
                return el;
            }
            return elmCache.get(id);
        };
        const setText = (id, text) => { const el = getElement(id); if (el) el.textContent = text; };
        
        // 4. Formateadores Reutilizables (OPTIMIZACIÓN FECHAS)
        const formatters = {
            clock: new Intl.DateTimeFormat('es-MX', { timeZone: 'America/Mexico_City', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }),
            shortTime: new Intl.DateTimeFormat('es-MX', { timeZone: 'America/Mexico_City', hour: '2-digit', minute: '2-digit', hour12: false }),
            dateISO: new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Mexico_City' }) // YYYY-MM-DD
        };

        // 5. Lógica de la App (Integrada en el Módulo)
        window.app = {
            data: { logs: [], config: { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 }, activeShift: null },
            userId: null, offline: false, editingId: null, date: new Date(), timer: null, processing: false, 
            editingTimerType: null, timeOffset: 0, isRegistering: false,

            init() {
                // Pide la hora real a una API externa
                fetch('https://worldtimeapi.org/api/timezone/America/Mexico_City')
                    .then(r => r.json())
                    .then(data => {
                        const serverTime = new Date(data.datetime).getTime();
                        const deviceTime = Date.now();
                        // Calculamos la diferencia: Si mi reloj está adelantado o atrasado
                        this.timeOffset = serverTime - deviceTime; 
                        
                        console.log("Hora sincronizada. Offset:", this.timeOffset);
                    })
                    .catch(err => console.log("Usando hora local (sin internet o error)"));

                this.updateRealClockUI();
                setInterval(() => this.updateRealClockUI(), 1000);
                
                // Scroll Listener
                window.addEventListener('scroll', () => {
                    const btn = getElement('scrollTopBtn');
                    if (btn) {
                        if (window.scrollY > 300) btn.classList.remove('translate-y-20', 'opacity-0');
                        else btn.classList.add('translate-y-20', 'opacity-0');
                    }
                });
                
                if (!auth) return this.goOffline();

                onAuthStateChanged(auth, async u => {
                    if (u) { 
                        this.userId = u.uid; 
                        this.offline = false; 
                        this.renderAuth(u);
                        getElement('login-view')?.classList.add('hidden');
                        const appView = getElement('app-view');
                        if(appView) {
                            appView.classList.remove('hidden');
                            setTimeout(() => appView.classList.add('animate-fade-in'), 50);
                        }
                        
                        // 1. Iniciar listener en tiempo real (Reemplazo de load())
                        this.listenToChanges(); 

                    } else {
                        // Limpiar listener al salir
                        if (unsubscribeListener) {
                            unsubscribeListener();
                            unsubscribeListener = null;
                        }

                        this.userId = null;
                        const appView = getElement('app-view');
                        if(appView) {
                            appView.classList.add('hidden');
                            appView.classList.remove('animate-fade-in');
                        }
                        getElement('login-view')?.classList.remove('hidden');
                        this.data = { logs: [], config: { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 }, activeShift: null };
                        
                        // 2. Solo cargamos local si NO hay usuario
                        this.loadLocal(); 
                    }
                });
            },

            // --- REAL TIME LISTENER (NUEVO) ---
            listenToChanges() {
                if (this.offline || !this.userId) return;
                
                // Si ya hay un listener, lo detenemos para no duplicar
                if (unsubscribeListener) unsubscribeListener();

                // ESCUCHA EN TIEMPO REAL (PUSH)
                try {
                    unsubscribeListener = onSnapshot(doc(db, "users", this.userId, "attendance", "sync_state"), (docSnap) => {
                        if (docSnap.exists()) {
                            const remoteData = docSnap.data();
                            
                            // Actualizamos datos locales con la verdad de la nube
                            this.data = remoteData;
                            this.data.logs = this.data.logs || [];
                            this.data.config = this.data.config || { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 };
                            
                            this.render();
                            this.uiClock();

                            // Efecto visual en el punto de sincronización
                            const dot = getElement('syncDot');
                            if(dot) {
                                dot.classList.remove('bg-red-500');
                                dot.classList.add('bg-green-500', 'shadow-[0_0_10px_rgba(34,197,94,0.5)]');
                                setTimeout(() => {
                                    dot.classList.remove('bg-green-500', 'shadow-[0_0_10px_rgba(34,197,94,0.5)]');
                                    dot.classList.add('bg-red-500');
                                }, 800);
                            }
                        }
                    }, (error) => {
                        console.error("Error en listener:", error);
                        // Opcional: Manejar desconexión visual
                    });
                } catch (e) {
                    console.error("Error iniciando snapshot:", e);
                }
            },

            // --- AUTH ---
            toggleAuth(mode) {
                this.isRegistering = (mode === 'register');
                getElement('auth-switch-container')?.classList.toggle('auth-mode-register', this.isRegistering);
                getElement('tab-login')?.classList.toggle('active', !this.isRegistering);
                getElement('tab-register')?.classList.toggle('active', this.isRegistering);
                getElement('auth-error-msg')?.classList.add('hidden');
                setText('btn-text', this.isRegistering ? "CREAR CUENTA" : "INICIAR SESIÓN");
                const nameField = getElement('field-name');
                if(nameField) this.isRegistering ? nameField.classList.remove('hidden') : nameField.classList.add('hidden');
            },

            async handleAuthSubmit() {
                const btn = getElement('btn-submit');
                const id = getElement('input-id')?.value.trim();
                const pass = getElement('input-pass')?.value;
                const name = getElement('input-name')?.value.trim();
                const errMsg = getElement('auth-error-msg');

                if (!id || !pass) return this.showAuthError("Completa todos los campos");
                if (this.isRegistering && !name) return this.showAuthError("El nombre es obligatorio");
                
                const finalId = id.includes('@') ? id : `${id}@godsplan.site`;

                if(btn) { btn.disabled = true; btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> PROCESANDO...'; }
                if(errMsg) errMsg.classList.add('hidden');

                try {
                    if (this.isRegistering) {
                        const cred = await createUserWithEmailAndPassword(auth, finalId, pass);
                        await updateProfile(cred.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(auth, finalId, pass);
                    }
                } catch (error) {
                    console.error(error);
                    this.showAuthError(this.mapAuthError(error.code));
                    if(btn) { 
                        btn.disabled = false; 
                        btn.innerHTML = `<span>${this.isRegistering ? 'CREAR CUENTA' : 'INICIAR SESIÓN'}</span> <i class="ph-bold ph-arrow-right"></i>`; 
                    }
                }
            },

            async loginGoogle() {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
                catch (error) { console.error(error); this.showAuthError("Error con Google."); }
            },

            showAuthError(msg) {
                setText('auth-error-txt', msg);
                getElement('auth-error-msg')?.classList.remove('hidden');
                const btn = getElement('btn-submit');
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<span>${this.isRegistering ? 'CREAR CUENTA' : 'INICIAR SESIÓN'}</span> <i class="ph-bold ph-arrow-right"></i>`;
                }
            },
            
            mapAuthError(code) {
                const errs = { 'auth/email-already-in-use': "ID registrado.", 'auth/invalid-email': "ID inválido.", 'auth/user-not-found': "Usuario no encontrado.", 'auth/wrong-password': "Contraseña incorrecta." };
                return errs[code] || "Error: " + code.split('/')[1];
            },

            // --- CORE ---
            updateRealClockUI() { setText('realClockTime', formatters.clock.format(new Date())); },
            getNow() { return Date.now() + this.timeOffset; },
            
            goOffline() { this.offline = true; this.loadLocal(); },
            
            renderAuth(u) {
                const isReal = u && !u.isAnonymous;
                let t = u ? (u.isAnonymous ? "ANÓNIMO" : (u.displayName || "Usuario")) : "DESCONECTADO";
                if (isReal && u.email && u.email.includes('@godsplan.site')) t = u.email.split('@')[0];
            },

            loadLocal() { const d = localStorage.getItem('godsPlanData'); if (d) { try { this.data = JSON.parse(d); this.render(); this.uiClock(); } catch (e) { } } },
            
            async save() {
                localStorage.setItem('godsPlanData', JSON.stringify(this.data));
                if (!this.offline && this.userId) {
                    // Al guardar, onSnapshot se disparará, pero eso está bien, asegura consistencia
                    await setDoc(doc(db, "users", this.userId, "attendance", "sync_state"), this.data, { merge: true });
                }
            },
            
            syncData() { 
                // Reiniciar el listener fuerza una actualización fresca
                this.listenToChanges(); 
                this.showSuccess("Sincronizando..."); 
            },
            
            uiClock() {
                const s = this.data.activeShift;
                const area = getElement('actionButtons');
                const off = getElement('offlineDisplay');
                const on = getElement('timersDisplay');
                const config = this.data.config || {}; 
                const bl = config.bathAllow || 15;
                const fl = config.foodAllow || 45;

                const btnBase = "btn-ctrl h-[55px] rounded-lg font-extrabold text-[0.85rem] cursor-pointer flex flex-col items-center justify-center gap-0.5 uppercase transition-all relative overflow-hidden active:scale-95";
                const btnStart = `${btnBase} col-span-2 text-lg h-[70px] text-white bg-gradient-to-br from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 border-none`;
                const btnStop = `${btnBase} col-span-2 text-white bg-gradient-to-br from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 border-none`;
                const btnBath = `${btnBase} bg-card text-text-mute border-2 border-blue-500/40 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-500/10`;
                const btnFood = `${btnBase} bg-card text-text-mute border-2 border-amber-500/40 hover:border-amber-500 hover:text-amber-500 hover:bg-amber-500/10`;
                const btnPause = `${btnBase} col-span-2 bg-card text-text-mute border-2 border-orange-600/40 hover:border-orange-500 hover:text-orange-500 hover:bg-orange-500/10`;

                const startEl = getElement('shiftStartTime');
                const bathEl = getElement('clockBathContainer');
                const foodEl = getElement('clockFoodContainer');
                const cs = getElement('clockStatus');

                if (!s) {
                    if(off) off.style.display = 'block'; 
                    if(on) on.style.display = 'none';
                    if(area) area.innerHTML = `<button class="${btnStart}" onclick="window.app.clockIn()"><i class="ph-bold ph-play"></i> INICIAR JORNADA</button>`;
                    if (this.timer) clearInterval(this.timer);
                    setText('clockStatus', "FUERA DE TURNO");
                    if(cs) { cs.classList.remove('animate-pulse-custom', 'text-warn'); }
                    if(startEl) startEl.style.display = 'none';
                } else {
                    if (!s.breaks) { s.breaks = { bathroom: 0, food: 0, pause: 0 }; this.save(); }
                    if (s.breaks.pause === undefined) s.breaks.pause = 0;

                    if(off) off.style.display = 'none'; 
                    if(on) on.style.display = 'grid';
                    setText('limBath', bl);
                    setText('limFood', fl);
                    
                    if(startEl && s.start) {
                        startEl.textContent = `ENTRADA: ${formatters.shortTime.format(new Date(s.start))}`;
                        startEl.style.display = 'block';
                    }

                    if(area) {
                        area.innerHTML = `
                            <button class="${btnBath} ${s.breakType === 'bathroom' ? 'active-bath' : ''}" onclick="window.app.toggleBreak('bathroom')"><i class="ph-bold ph-toilet"></i> BAÑO</button>
                            <button class="${btnFood} ${s.breakType === 'food' ? 'active-food' : ''}" onclick="window.app.toggleBreak('food')"><i class="ph-bold ph-hamburger"></i> COMIDA</button>
                            <button class="${btnPause} ${s.breakType === 'pause' ? 'active-pause' : ''}" onclick="window.app.toggleBreak('pause')"><i class="ph-bold ph-pause-circle"></i> ${s.breakType === 'pause' ? 'REANUDAR' : 'PAUSAR / DESCONEXIÓN'}</button>
                            <button class="${btnStop}" onclick="window.app.confirmClockOut()"><i class="ph-bold ph-stop"></i> TERMINAR JORNADA</button>
                        `;
                    }

                    if (this.timer) clearInterval(this.timer);
                    
                    // Función optimizada de intervalo (usa caché de elementos)
                    this.timer = setInterval(() => {
                        const now = this.getNow();
                        let totalPauseAccumulated = (s.breaks.pause || 0) * 60000;
                        let currentPauseDuration = 0;
                        
                        if (s.breakType === 'pause') {
                            setText('clockStatus', "PAUSADO");
                            if(cs) cs.classList.add('animate-pulse-custom', 'text-warn');
                            currentPauseDuration = now - s.breakStart;
                        } else {
                            setText('clockStatus', "TURNO ACTIVO");
                            if(cs) cs.classList.remove('animate-pulse-custom', 'text-warn');
                        }

                        let displayTime = (now - s.start) - totalPauseAccumulated - currentPauseDuration;
                        setText('clockDisplay', this.msToTime(displayTime));

                        let b = s.breaks.bathroom || 0, f = s.breaks.food || 0;
                        if (s.breakStart) {
                            const d = (now - s.breakStart) / 60000;
                            if (s.breakType === 'bathroom') b += d; else if (s.breakType === 'food') f += d;
                        }
                        
                        setText('dispBath', this.fmtBreak(b));
                        if(bathEl) {
                            s.breakType === 'bathroom' ? bathEl.classList.add('active') : bathEl.classList.remove('active');
                            b > bl ? bathEl.classList.add('danger') : bathEl.classList.remove('danger');
                        }
                        const bathRem = bl - b;
                        const elRemBath = getElement('remBath');
                        if (elRemBath) {
                            elRemBath.textContent = bathRem >= 0 ? `Restan: ${this.fmtBreak(bathRem)}` : `Exceso: ${this.fmtBreak(Math.abs(bathRem))}`;
                            elRemBath.className = bathRem >= 0 ? 'text-[0.7rem] font-extrabold mt-1 text-money' : 'text-[0.7rem] font-extrabold mt-1 text-alert';
                        }

                        setText('dispFood', this.fmtBreak(f));
                        if(foodEl) {
                            s.breakType === 'food' ? foodEl.classList.add('active') : foodEl.classList.remove('active');
                            f > fl ? foodEl.classList.add('danger') : foodEl.classList.remove('danger');
                        }
                        const foodRem = fl - f;
                        const elRemFood = getElement('remFood');
                        if (elRemFood) {
                            elRemFood.textContent = foodRem >= 0 ? `Restan: ${this.fmtBreak(foodRem)}` : `Exceso: ${this.fmtBreak(Math.abs(foodRem))}`;
                            elRemFood.className = foodRem >= 0 ? 'text-[0.7rem] font-extrabold mt-1 text-money' : 'text-[0.7rem] font-extrabold mt-1 text-alert';
                        }
                    }, 1000);
                }
            },
            
            // --- TIME & CALCULATIONS ---
            fmt(m) { const r = Math.round(m); const a = Math.abs(r); return `${r < 0 ? '-' : ''}${Math.floor(a / 60)}:${(a % 60).toString().padStart(2, '0')}`; },
            fmtBreak(m) { return `${Math.floor(m).toString().padStart(2, '0')}:${Math.floor((m % 1) * 60).toString().padStart(2, '0')}`; },
            msToTime(ms) { const s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60); return `${h}:${(m % 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`; },
            getWeek(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var y = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - y) / 86400000) + 1) / 7); },
            calcHours(i, o) { if (!i || !o) return 0; const [h1, m1] = i.split(':'), [h2, m2] = o.split(':'); const d = ((h2 * 60 + +m2) - (h1 * 60 + +m1)); return d < 0 ? -1 : d; },
            calcStats(logs) { let t = 0, w = 0, f = 0; logs.forEach(l => { t += (l.type === 'Laboral' || l.type === 'Falta') ? 480 : 0; w += (l.type === 'Laboral' || l.type === 'Descanso') ? (l.hours - (l.disconnection || 0)) : 0; if (l.type === 'Falta') f++; }); return { target: t, worked: w, bal: w - t, fails: f }; },

            // --- ACTIONS ---
            openTimerEdit(type) {
                if (!this.data.activeShift) return;
                this.editingTimerType = type;
                let currentTotal = this.data.activeShift.breaks[type] || 0;
                if (this.data.activeShift.breakStart && this.data.activeShift.breakType === type) {
                    currentTotal += (this.getNow() - this.data.activeShift.breakStart) / 60000;
                }
                setText('timerEditTitle', type === 'bathroom' ? 'Baño' : 'Comida');
                const m = Math.floor(currentTotal);
                const s = Math.floor((currentTotal % 1) * 60);
                const inp = getElement('inpTimerEdit');
                if(inp) inp.value = `${m}:${s.toString().padStart(2, '0')}`; 
                this.toggleModal('timerEditModal', true);
                if(inp) setTimeout(() => inp.focus(), 100);
            },

            saveTimerEdit() {
                if (!this.editingTimerType || !this.data.activeShift) return;
                const inp = getElement('inpTimerEdit');
                const valStr = inp ? inp.value.trim() : '0';
                let newVal = 0;
                if (valStr.includes(':')) {
                    const parts = valStr.split(':');
                    newVal = (parseInt(parts[0]) || 0) + ((parseInt(parts[1]) || 0) / 60);
                } else newVal = parseFloat(valStr);
                
                if (isNaN(newVal) || newVal < 0) return this.showMessage("Tiempo inválido");
                
                // Actualizar shift
                this.data.activeShift.breaks[this.editingTimerType] = newVal;
                if (this.data.activeShift.breakStart && this.data.activeShift.breakType === this.editingTimerType) {
                    this.data.activeShift.breakStart = this.getNow();
                }
                this.save(); this.uiClock(); this.toggleModal('timerEditModal', false);
            },

            clockIn() {
                if (this.processing) return; this.processing = true;
                this.stopBreak();
                this.data.activeShift = { start: this.getNow(), breaks: { bathroom: 0, food: 0, pause: 0 }, breakStart: null, breakType: null };
                this.save(); this.uiClock(); this.processing = false;
            },
            toggleBreak(type) {
                const s = this.data.activeShift; if (!s) return;
                if (s.breakStart) {
                    const prev = s.breakType;
                    this.stopBreak();
                    if (prev !== type) setTimeout(() => this.startBreak(type), 50);
                } else this.startBreak(type);
            },
            startBreak(t) { this.data.activeShift.breakStart = this.getNow(); this.data.activeShift.breakType = t; this.save(); this.uiClock(); },
            stopBreak() {
                const s = this.data.activeShift;
                if (s && s.breakStart) {
                    if (s.breakType) {
                        if (s.breaks[s.breakType] === undefined) s.breaks[s.breakType] = 0;
                        s.breaks[s.breakType] += (this.getNow() - s.breakStart) / 60000;
                    }
                    s.breakStart = null; s.breakType = null;
                    this.save(); this.uiClock();
                }
            },
            confirmClockOut() { if (this.data.activeShift.breakStart) this.stopBreak(); if (this.data.activeShift) this.toggleModal('clockOutModal', true); },
            finishShiftReal() {
                const s = this.data.activeShift; if (!s) return;
                if (s.breakStart) this.stopBreak(); 
                if (!s.breaks) s.breaks = { bathroom: 0, food: 0, pause: 0 };
                
                const end = this.getNow();
                const totalWallTime = (end - s.start) / 60000;
                const pauseTime = s.breaks.pause || 0;
                const gross = totalWallTime - pauseTime;
                
                const b = s.breaks.bathroom || 0, f = s.breaks.food || 0;
                const config = this.data.config || {}; 
                const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                
                // Usar formateadores cacheados
                const logDate = formatters.dateISO.format(new Date(s.start));
                const logIn = formatters.shortTime.format(new Date(s.start));
                const logOut = formatters.shortTime.format(new Date(end));

                this.data.logs.push({
                    id: this.getNow(), date: logDate, type: 'Laboral', in: logIn, out: logOut, hours: gross, disconnection: disc, details: { bath: b, food: f, pause: pauseTime }
                });
                this.data.activeShift = null;
                this.save(); this.render(); this.uiClock(); this.toggleModal('clockOutModal', false);
            },

            render() {
                const d = this.date, m = d.getMonth(), y = d.getFullYear();
                setText('monthLabel', `${["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"][m]} ${y}`);
                const wn = this.getWeek(d);
                setText('weekNum', wn);

                const wLogs = this.data.logs.filter(l => this.getWeek(new Date(l.date + 'T00:00')) === wn && new Date(l.date).getFullYear() === y);
                const wRes = this.calcStats(wLogs);
                setText('weekTarget', this.fmt(wRes.target));
                setText('weekWorked', this.fmt(wRes.worked));
                this.setBadge('weekBalance', wRes.bal);
                const config = this.data.config || {}; 
                let pay = 0, he = Math.floor(wRes.bal / 60);
                if (wRes.bal > 0) pay = (he <= 12) ? he * (config.rate1 || 50) : (12 * (config.rate1 || 50)) + ((he - 12) * (config.rate1 || 50));
                setText('weekPay', `$${Math.round(pay)}`);

                const isQ1 = d.getDate() <= 15;
                setText('qName', isQ1 ? 'Q1' : 'Q2');
                const qLogs = this.data.logs.filter(l => { const x = new Date(l.date + 'T00:00'); return x.getMonth() === m && (isQ1 ? x.getDate() <= 15 : x.getDate() > 15); });
                const qRes = this.calcStats(qLogs);
                setText('qTarget', this.fmt(qRes.target));
                setText('qWorked', this.fmt(qRes.worked));
                this.setBadge('qBalance', qRes.bal);
                setText('qFails', qRes.fails);

                const list = getElement('logList'); 
                if(list) {
                    list.innerHTML = '';
                    const mLogs = this.data.logs.filter(l => new Date(l.date + 'T00:00').getMonth() === m).sort((a, b) => new Date(b.date) - new Date(a.date));
                    mLogs.forEach(l => {
                        const x = new Date(l.date + 'T00:00');
                        const net = (l.type === 'Laboral' || l.type === 'Descanso') ? (l.hours - (l.disconnection || 0)) : 0;
                        const bal = net - ((l.type === 'Laboral' || l.type === 'Falta') ? 480 : 0);
                        let chips = '';
                        if (l.details) {
                            const pillClass = "px-1.5 py-0.5 rounded flex items-center gap-1 font-semibold text-[0.7rem] border border-border bg-bg/50 text-text-mute";
                            const excessClass = "bg-red-900/40 text-red-300 border-red-900";
                            if (l.details.bath > 0) chips += `<span class="${pillClass} ${l.details.bath > (config.bathAllow || 15) ? excessClass : ''}"><i class="ph-bold ph-toilet"></i> ${Math.round(l.details.bath)}m</span>`;
                            if (l.details.food > 0) chips += `<span class="${pillClass} ${l.details.food > (config.foodAllow || 45) ? excessClass : ''}"><i class="ph-bold ph-hamburger"></i> ${Math.round(l.details.food)}m</span>`;
                            if (l.details.pause > 0) chips += `<span class="${pillClass} text-warn border-warn"><i class="ph-bold ph-pause-circle"></i> ${Math.round(l.details.pause)}m</span>`;
                        }
                        const hourText = (l.type === 'Laboral' || (l.type === 'Descanso' && l.hours > 0)) ? `${l.in ? l.in + '-' + l.out + ' • ' : ''}<b>${this.fmt(net)}</b>` : '';
                        
                        let tagClass = "px-2.5 py-1 rounded-md text-[0.7rem] font-extrabold uppercase inline-flex items-center justify-center leading-none tracking-wide ";
                        if(l.type === 'Laboral') tagClass += "bg-blue-900/30 text-blue-200";
                        else if(l.type === 'Descanso') tagClass += "bg-slate-800 text-slate-300 border border-white/5";
                        else if(l.type === 'Falta') tagClass += "bg-red-900/30 text-red-200";
                        else if(l.type === 'Vacaciones') tagClass += "bg-amber-900/30 text-amber-200";

                        const balClass = bal >= 0 ? "bg-emerald-900/30 text-emerald-300" : "bg-red-900/30 text-red-300";
                        const div = document.createElement('div'); 
                        div.className = 'p-4 border-b border-border grid grid-cols-[45px_1fr_auto] gap-4 items-center hover:bg-white/5 transition-colors cursor-pointer last:border-b-0'; 
                        div.onclick = () => window.app.openModal(l.id); 
                        div.innerHTML = `
                            <div class="bg-card border border-border rounded-lg text-center py-1.5 flex flex-col items-center justify-center">
                                <div class="text-base font-extrabold text-text leading-none mb-0.5">${x.getDate()}</div>
                                <div class="text-[0.65rem] uppercase text-text-mute font-bold">${['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][x.getDay()]}</div>
                            </div>
                            <div class="flex flex-col gap-1.5">
                                <div class="flex items-center text-[0.85rem] font-semibold text-text"><span class="${tagClass}">${l.type}</span></div>
                                ${hourText ? `<div class="text-[0.8rem] text-text-mute flex gap-2 items-center font-medium">${hourText}</div>` : ''}
                                <div class="flex gap-1.5 flex-wrap text-[0.7rem]">${chips}</div>
                            </div>
                            <div class="text-center font-extrabold text-[0.8rem] px-2 py-1 rounded-md justify-self-end min-w-[60px] ${balClass}">${bal > 0 ? '+' : ''}${this.fmt(bal)}</div>`;
                        list.appendChild(div);
                    });
                }
            },

            // --- UI HELPERS ---
            setBadge(id, v) { 
                const e = getElement(id); 
                if(e) {
                    e.textContent = (v > 0 ? '+' : '') + this.fmt(v); 
                    e.className = `px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] ${v >= 0 ? 'bg-emerald-900/30 text-emerald-300' : 'bg-red-900/30 text-red-300'}`; 
                }
            },
            changeMonth(n) { this.date.setMonth(this.date.getMonth() + n); this.date.setDate(1); this.render(); },
            changeWeek(n) { this.date.setDate(this.date.getDate() + (n * 7)); this.render(); },
            goToday() { this.date = new Date(); this.render(); },
            
            // Unificando modales
            toggleModal(id, show) {
                const m = getElement(id);
                if(m) {
                    if(show) { m.classList.remove('hidden'); m.classList.add('flex'); }
                    else { m.classList.remove('flex'); m.classList.add('hidden'); }
                }
            },
            
            openConfigModal() { 
                const inpBath = getElement('cfgBath'); const inpFood = getElement('cfgFood');
                const inpRate1 = getElement('cfgRate1'); const inpRate2 = getElement('cfgRate2');
                if(inpBath) inpBath.value = this.data.config.bathAllow || 15; 
                if(inpFood) inpFood.value = this.data.config.foodAllow || 45; 
                if(inpRate1) inpRate1.value = this.data.config.rate1; 
                if(inpRate2) inpRate2.value = this.data.config.rate2; 
                this.switchTab('tSettings'); 
                this.toggleModal('configModal', true);
            },
            
            saveConfig() { 
                const inpBath = getElement('cfgBath'); const inpFood = getElement('cfgFood');
                const inpRate1 = getElement('cfgRate1'); const inpRate2 = getElement('cfgRate2');
                this.data.config.bathAllow = inpBath ? (parseFloat(inpBath.value) || 15) : 15; 
                this.data.config.foodAllow = inpFood ? (parseFloat(inpFood.value) || 45) : 45; 
                this.data.config.rate1 = inpRate1 ? (parseFloat(inpRate1.value) || 50) : 50; 
                this.data.config.rate2 = inpRate2 ? (parseFloat(inpRate2.value) || 75) : 75; 
                this.save(); this.toggleModal('configModal', false); 
            },
            
            switchTab(id) { 
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); 
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active', 'block')); 
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); 
                if(event && event.target) event.target.classList.add('active'); 
                const el = getElement(id);
                if(el) { el.classList.add('active', 'block'); el.classList.remove('hidden'); }
            },
            
            logout() { signOut(auth).then(() => window.location.reload()); }, 
            
            resetData() { if (confirm("¿Borrar todo?")) { this.data = { logs: [], config: this.data.config, activeShift: null }; this.save(); location.reload(); } },

            openModal(id = null) {
                this.editingId = id; 
                this.toggleModal('logModal', true);

                const now = new Date().toISOString().split('T')[0];
                const inpDate = getElement('inpDate'); const inpType = getElement('inpType');
                const inpIn = getElement('inpIn'); const inpOut = getElement('inpOut');
                const inpBath = getElement('inpBathTime'); const inpFood = getElement('inpFoodTime'); const inpPause = getElement('inpPauseTime');

                if(inpDate) inpDate.value = now; if(inpType) inpType.value = 'Laboral';
                if(inpIn) inpIn.value = ''; if(inpOut) inpOut.value = '';
                if(inpBath) inpBath.value = 0; if(inpFood) inpFood.value = 0; if(inpPause) inpPause.value = 0;

                const btnDel = getElement('btnDelete');
                if (id) {
                    if(btnDel) btnDel.classList.remove('hidden');
                    const l = this.data.logs.find(x => x.id === id);
                    if(l) {
                        if(inpDate) inpDate.value = l.date; if(inpType) inpType.value = l.type;
                        if(inpIn) inpIn.value = l.in; if(inpOut) inpOut.value = l.out;
                        if (l.details) { 
                            if(inpBath) inpBath.value = Math.round(l.details.bath); 
                            if(inpFood) inpFood.value = Math.round(l.details.food); 
                            if(inpPause) inpPause.value = l.details.pause ? Math.round(l.details.pause) : 0;
                        }
                    }
                } else {
                    if(btnDel) btnDel.classList.add('hidden');
                }
                this.toggleTimeInputs();
            },
            
            toggleTimeInputs() { 
                const typeEl = getElement('inpType'); const timeInputs = getElement('timeInputs');
                if(typeEl && timeInputs) timeInputs.style.display = (typeEl.value === 'Falta' || typeEl.value === 'Vacaciones') ? 'none' : 'block'; 
            },
            
            calcPreview() { 
                const i = getElement('inpIn')?.value; const o = getElement('inpOut')?.value;
                const b = parseFloat(getElement('inpBathTime')?.value) || 0;
                const f = parseFloat(getElement('inpFoodTime')?.value) || 0;
                const p = parseFloat(getElement('inpPauseTime')?.value) || 0; 
                const g = this.calcHours(i, o);
                const config = this.data.config || {};
                const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                setText('calcHoursDisplay', g === -1 ? 'Error' : this.fmt(g - p - disc));
            },
            
            saveLog() {
                const d = getElement('inpDate')?.value; const t = getElement('inpType')?.value;
                const i = getElement('inpIn')?.value; const o = getElement('inpOut')?.value;
                const b = parseFloat(getElement('inpBathTime')?.value) || 0;
                const f = parseFloat(getElement('inpFoodTime')?.value) || 0;
                const p = parseFloat(getElement('inpPauseTime')?.value) || 0;

                if (!d) return this.showMessage("Fecha requerida");
                let h = 0, disc = 0; 
                if (t === 'Laboral') {
                    if (!i || !o) return this.showMessage("Requiere entrada y salida");
                    h = this.calcHours(i, o) - p; 
                    if (h <= 0) return this.showMessage("Horario inválido"); 
                } else if (t === 'Descanso') {
                    if (i && o) { h = this.calcHours(i, o) - p; if (h < 0) return this.showMessage("Horario inválido"); } else { h = 0; }
                }
                if (t === 'Laboral' || (t === 'Descanso' && h > 0)) {
                    const config = this.data.config || {};
                    disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                }

                const log = { id: this.editingId || this.getNow(), date: d, type: t, in: i || '', out: o || '', hours: h, disconnection: disc, details: { bath: b, food: f, pause: p } };
                if (this.editingId) this.data.logs[this.data.logs.findIndex(x => x.id === this.editingId)] = log; else this.data.logs.push(log);
                this.save(); this.render(); this.toggleModal('logModal', false);
            },
            
            deleteLog() { if (confirm("¿Eliminar?")) { this.data.logs = this.data.logs.filter(x => x.id !== this.editingId); this.save(); this.render(); this.toggleModal('logModal', false); } },
            
            showMessage(m) { setText('msgText', m); const i = getElement('msgIcon'); if(i) i.className = 'ph-fill ph-warning-circle text-alert'; this.toggleModal('msgModal', true); },
            showSuccess(m) { setText('msgText', m); const i = getElement('msgIcon'); if(i) i.className = 'ph-fill ph-check-circle text-money'; this.toggleModal('msgModal', true); },
            
            processImport() { 
                const ta = getElement('importTextArea'); const t = ta ? ta.value : ''; 
                if (!t) return; 
                const l = t.split('\n'); let c = 0; 
                l.forEach(x => { const p = x.split(/[\t,]+/); if (p.length >= 4) { this.data.logs.push({ id: Date.now() + c, date: p[0], type: p[1], in: p[2], out: p[3], hours: this.calcHours(p[2], p[3]), disconnection: 0 }); c++; } }); 
                this.save(); this.toggleModal('importModal', false); this.showSuccess(c + " importados"); 
            },
            
            importJson(input) {
                const file = input.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json.logs)) {
                            let count = 0;
                            json.logs.forEach(l => { if (!this.data.logs.find(x => x.id === l.id)) { this.data.logs.push(l); count++; } });
                            if(json.config) this.data.config = { ...this.data.config, ...json.config };
                            this.save(); this.render(); this.showSuccess(count > 0 ? `${count} recuperados` : "Actualizado");
                        } else this.showMessage("Archivo inválido");
                    } catch (err) { this.showMessage("Error JSON"); }
                    input.value = ''; 
                };
                reader.readAsText(file);
            },
            exportBackup() { const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(this.data)); a.download = 'backup.json'; a.click(); }
        };

        // Event Listener para extensión externa (si existe)
        window.addEventListener("message", (event) => {
            if (event.data.type !== "GODSPLAN_COMMAND") return;
            const action = event.data.action;
            switch(action) {
                case 'RESUME_WORK': window.app.data.activeShift ? window.app.stopBreak() : window.app.clockIn(); break;
                case 'START_BREAK_FOOD': if (!window.app.data.activeShift) window.app.clockIn(); window.app.startBreak('food'); break;
                case 'START_BREAK_BATH': if (!window.app.data.activeShift) window.app.clockIn(); window.app.startBreak('bathroom'); break;
                case 'END_SHIFT': if (window.app.data.activeShift) window.app.finishShiftReal(); break;
            }
        });

        // Handler de errores
        window.onerror = function (m) { if (!String(m).includes('popup')) window.app.showMessage(m); };

        // Iniciar
        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
