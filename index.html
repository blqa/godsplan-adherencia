<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gods Plan | Adherencia</title>
    
    <!-- FAVICON -->
    <link rel="shortcut icon" href="./favicon.ico?v=2" type="image/x-icon">
    <link rel="icon" href="./favicon.ico?v=2" type="image/x-icon">

    <!-- FUENTE UNIFICADA: PLUS JAKARTA SANS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- TAILWIND CSS & CONFIGURACIÓN DE TEMA -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg)',
                        card: 'var(--card)',
                        text: 'var(--text)',
                        'text-mute': 'var(--text-mute)',
                        brand: 'var(--brand)', // Rojo Sangre App
                        money: 'var(--money)',
                        alert: 'var(--alert)',
                        warn: 'var(--warn)',
                        border: 'var(--border)',
                        'input-bg': 'var(--input-bg)',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'nebula': 'nebula 20s infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        nebula: {
                            '0%': { transform: 'scale(1)', opacity: '0.3' },
                            '100%': { transform: 'scale(1.2)', opacity: '0.6' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        fadeIn: { 
                            from: { opacity: 0, transform: 'translateY(-5px)' }, 
                            to: { opacity: 1, transform: 'translateY(0)' } 
                        }
                    }
                }
            }
        }
    </script>

    <!-- FIREBASE MODULAR (v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where,
            setPersistence, browserLocalPersistence
        };
    </script>

    <style>
        /* --- DEFINICIÓN DE VARIABLES DE TEMA ÚNICO (RED/DARK) --- */
        :root {
            --bg: #000000;
            --card: #111111;
            --text: #e5e5e5;
            --text-mute: #737373;
            --brand: #dc2626;  /* Rojo Sangre App */
            --login-brand: #E70000; /* Rojo Login */
            --money: #16a34a;
            --alert: #b91c1c;
            --warn: #d97706;
            --border: #262626;
            --input-bg: #0a0a0a;
            --header-bg: rgba(0, 0, 0, 0.9);
        }

        /* RESET & UTILIDADES ESPECÍFICAS */
        * { -webkit-tap-highlight-color: transparent; outline: none; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { overflow-x: hidden; }
        
        /* Ocultar scrollbar en navegación */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { border: 4px solid var(--border); border-top: 4px solid var(--brand); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }

        /* --- ESTILOS DEL LOGIN --- */
        .aurora-bg {
            position: fixed; inset: 0; z-index: -2;
            background: 
                radial-gradient(circle at 50% 50%, rgba(50, 0, 0, 0.4) 0%, transparent 60%),
                radial-gradient(circle at 80% 20%, rgba(231, 0, 0, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 20% 80%, rgba(100, 0, 0, 0.2) 0%, transparent 40%);
            filter: blur(80px);
            animation: nebula 15s infinite alternate ease-in-out;
            pointer-events: none;
        }

        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            pointer-events: none;
        }

        .input-gp {
            background: rgba(255,255,255,0.03); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            width: 100%; padding: 14px 16px; border-radius: 16px;
            font-size: 0.95rem; font-weight: 500;
        }
        .input-gp:focus { 
            border-color: #E70000; 
            outline: none; 
            background: rgba(231,0,0,0.05); 
            box-shadow: 0 0 20px rgba(231,0,0,0.2);
            transform: translateY(-2px);
        }
        .input-gp::placeholder { color: rgba(255,255,255,0.3); }

        .glass-panel {
            background: rgba(15, 15, 15, 0.6);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .auth-switch {
            position: relative; display: flex; background: rgba(0,0,0,0.3);
            border-radius: 12px; padding: 4px; margin-bottom: 24px;
        }
        .auth-switch button {
            flex: 1; padding: 8px; font-size: 0.8rem; font-weight: 700; z-index: 1;
            color: #666; transition: 0.3s;
        }
        .auth-switch button.active { color: white; }
        .auth-switch-glider {
            position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); width: calc(50% - 4px);
            background: #222; border-radius: 8px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .auth-mode-register .auth-switch-glider { transform: translateX(100%); }

        .btn-glow {
            position: relative; overflow: hidden;
            background: #E70000; color: white;
            transition: all 0.3s;
        }
        .btn-glow:hover {
            box-shadow: 0 0 30px rgba(231, 0, 0, 0.4);
            transform: translateY(-2px);
        }

        /* --- ESTILOS APP --- */
        .g-link.active { color: #fff; border-bottom: 2px solid #fff; padding-bottom: 2px; }
        .btn-ctrl.active-bath { background: var(--card); color: var(--brand) !important; border-color: var(--brand) !important; box-shadow: inset 0 0 0 1px var(--brand); }
        .btn-ctrl.active-food { background: var(--card); color: var(--warn) !important; border-color: var(--warn) !important; box-shadow: inset 0 0 0 1px var(--warn); }
        .btn-ctrl.active-pause { background: #451a03; color: #fb923c !important; border-color: #fb923c !important; box-shadow: inset 0 0 0 1px #f97316; }
        .side-clock.active { opacity: 1; transform: scale(1.05); background: transparent; }
        .side-clock.danger .side-val { color: var(--alert) !important; }
        .tab { @apply text-text-mute rounded-md transition-all; }
        .tab.active { @apply bg-white/10 text-white shadow-sm ring-1 ring-white/10 font-bold; }
        input, select, textarea { color: var(--text) !important; }
    </style>
</head>

<body class="bg-bg text-text font-sans selection:bg-brand selection:text-white min-h-screen">

    <!-- FONDOS GLOBALES -->
    <div class="aurora-bg"></div>
    <div class="grid-bg"></div>

    <!-- ============================================ -->
    <!--             VISTA 1: LOGIN / REGISTER       -->
    <!-- ============================================ -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-[#030000]">
        
        <!-- Logo Flotante -->
        <div class="absolute top-8 left-8 flex items-center gap-3 animate-fade-in opacity-50">
             <div class="relative w-8 h-8 flex items-center justify-center">
                <i class="ph-fill ph-planet text-2xl text-brand"></i>
            </div>
            <span class="font-bold tracking-widest text-lg">GOD'S PLAN</span>
        </div>

        <div class="w-full max-w-md animate-float">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-2">GOD'S PLAN</h1>
                <p class="text-zinc-500 text-sm font-mono tracking-widest uppercase">Portal de Acceso Centralizado</p>
            </div>

            <div class="glass-panel rounded-3xl p-8 relative overflow-hidden">
                <!-- Luces decorativas internas -->
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-brand blur-md opacity-50"></div>

                <!-- Switcher -->
                <div class="auth-switch" id="auth-switch-container">
                    <div class="auth-switch-glider"></div>
                    <button onclick="window.app.toggleAuth('login')" id="tab-login" class="active">INGRESAR</button>
                    <button onclick="window.app.toggleAuth('register')" id="tab-register">REGISTRARSE</button>
                </div>

                <form onsubmit="event.preventDefault(); window.app.handleAuthSubmit();" class="flex flex-col gap-5">
                    
                    <!-- Campo Nombre (Solo Registro) -->
                    <div id="field-name" class="hidden transition-all duration-300">
                        <div class="relative group">
                            <i class="ph-bold ph-user absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                            <input type="text" id="input-name" class="input-gp pl-12" placeholder="Tu Nombre">
                        </div>
                    </div>

                    <!-- Campo ID/Email -->
                    <div class="relative group">
                        <i class="ph-bold ph-identification-card absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                        <input type="text" id="input-id" class="input-gp pl-12" placeholder="ID (Ej: 17620) o Email" required>
                    </div>

                    <!-- Campo Password -->
                    <div class="relative group">
                        <i class="ph-bold ph-lock-key absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                        <input type="password" id="input-pass" class="input-gp pl-12" placeholder="Contraseña Maestra" required>
                    </div>

                    <!-- Mensaje Error -->
                    <div id="auth-error-msg" class="hidden p-3 bg-red-500/10 border border-red-500/20 rounded-xl text-red-400 text-xs font-bold text-center flex items-center justify-center gap-2">
                        <i class="ph-fill ph-warning-circle"></i> <span id="auth-error-txt">Error</span>
                    </div>

                    <!-- Botón Acción -->
                    <button type="submit" id="btn-submit" class="btn-glow w-full py-4 rounded-xl font-black uppercase tracking-widest text-sm mt-2 flex items-center justify-center gap-2 group cursor-pointer">
                        <span id="btn-text">INICIAR SESIÓN</span>
                        <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </form>

                <div class="relative my-6 text-center">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                    <span class="relative bg-[#0a0a0a] px-2 text-[10px] text-zinc-600 font-bold uppercase tracking-widest">O accede con</span>
                </div>

                <!-- Botón Google -->
                <button onclick="window.app.loginGoogle()" class="w-full bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-3 group cursor-pointer">
                    <i class="ph-bold ph-google-logo text-xl group-hover:text-brand transition-colors"></i>
                    <span>Google Account</span>
                </button>
            </div>
        </div>
        
        <footer class="absolute bottom-4 left-0 w-full text-center pointer-events-none opacity-30">
            <p class="text-[10px] font-mono tracking-[0.5em] text-white">SYSTEM v2.0 // SECURE</p>
        </footer>
    </div>


    <!-- ============================================ -->
    <!--             VISTA 2: APP PRINCIPAL          -->
    <!-- ============================================ -->
    <div id="app-view" class="hidden min-h-screen pb-24 pt-20">

        <!-- HEADER APP -->
        <header class="bg-card border-b border-border py-2.5 px-4 fixed top-0 left-0 w-full z-50 flex justify-between items-center shadow-sm flex-wrap gap-2.5 transition-all">
            <div class="text-[1.1rem] font-extrabold flex items-center gap-2 text-text uppercase">
                <i class="ph-fill ph-check-circle text-brand"></i>
                    <span>Panel de Control</span>
                </div>
            <div class="flex items-center gap-2 flex-wrap justify-end flex-1 md:flex-none">
                <!-- RELOJ REAL CDMX -->
                <div id="realWorldClock" class="flex flex-col items-end mr-1 px-2 py-0.5 border-r border-border/50 min-w-[70px]">
                    <div class="text-[0.6rem] text-text-mute font-black tracking-wider leading-none mb-0.5 flex items-center gap-1 justify-end">
                          <span id="syncDot" class="w-1.5 h-1.5 rounded-full bg-red-500 inline-block"></span> CDMX
                    </div>
                    <div class="text-[0.9rem] font-mono font-bold text-text leading-none tabular-nums text-right" id="realClockTime">--:--:--</div>
                </div>

                <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg hover:text-text cursor-pointer" onclick="window.app.syncData()" title="Sincronizar"><i class="ph-bold ph-arrows-clockwise"></i></button>
                <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg hover:text-text cursor-pointer" onclick="window.app.openConfigModal()" title="Menú"><i class="ph-bold ph-gear"></i></button>
                
                <div class="flex items-center gap-1 bg-bg px-2 py-1 rounded-full border border-border">
                    <button class="bg-transparent border-none text-text-mute cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:text-text" onclick="window.app.changeMonth(-1)"><i class="ph-bold ph-caret-left"></i></button>
                    <span class="text-[0.85rem] font-extrabold uppercase text-text min-w-[75px] text-center" id="monthLabel">--</span>
                    <button class="bg-transparent border-none text-text-mute cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:text-text" onclick="window.app.changeMonth(1)"><i class="ph-bold ph-caret-right"></i></button>
                    <button class="bg-transparent border-none text-brand cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:scale-110 transition-transform" onclick="window.app.goToday()"><i class="ph-bold ph-calendar-check"></i></button>
                </div>
            </div>
        </header>

        <div class="w-full max-w-[900px] mx-auto p-4 overflow-x-hidden">
            <!-- RELOJ PRINCIPAL DE LA APP -->
            <div class="bg-card rounded-2xl border border-border py-5 px-2.5 text-center mb-5 shadow-sm relative overflow-hidden">
                <div id="mainLoader" class="absolute inset-0 bg-card/90 flex items-center justify-center z-10 rounded-2xl hidden">
                    <div class="spinner"></div>
                </div>

                <!-- Timer Grid -->
                <div class="grid grid-cols-[1fr_1.2fr_1fr] items-center gap-1.5 mb-5" id="timersDisplay" style="display:none;">
                    <!-- Baño -->
                    <button class="side-clock flex flex-col items-center justify-center opacity-50 p-1.5 rounded-lg relative z-10 w-full h-full border-none hover:bg-bg hover:opacity-100 hover:scale-105 transition-all cursor-pointer" id="clockBathContainer" onclick="window.app.openTimerEdit('bathroom')" type="button">
                        <div class="text-[0.65rem] font-extrabold uppercase text-text-mute mb-1 flex items-center justify-center gap-1">
                            <i class="ph-bold ph-toilet"></i> Baño <i class="ph-bold ph-pencil-simple text-brand text-[0.9em]"></i>
                        </div>
                        <div class="font-mono font-bold text-base text-text tabular-nums" id="dispBath">00:00</div>
                        <div class="text-[0.65rem] text-text-mute mt-0.5">/ <span id="limBath">15</span>m</div>
                        <div id="remBath" class="text-[0.7rem] font-extrabold mt-1 text-money">Restan: --</div>
                    </button>
                    
                    <!-- Reloj Principal -->
                    <div class="flex flex-col items-center">
                        <div class="text-[0.7rem] uppercase tracking-widest text-text-mute font-extrabold mb-1.5" id="clockStatus">TURNO ACTIVO</div>
                        <div class="text-[clamp(2.5rem,12vw,4rem)] font-extrabold text-text tabular-nums leading-none" id="clockDisplay">00:00</div>
                        
                        <div id="shiftStartTime" class="text-[0.7rem] text-text-mute font-bold mt-1.5 uppercase tracking-wide opacity-80" style="display:none;">
                            ENTRADA: --:--
                        </div>

                        <div id="networkTimeBadge" class="text-[0.65rem] text-money font-bold mt-1.5 opacity-0 transition-opacity duration-500">
                            <i class="ph-bold ph-globe"></i> Local
                        </div>
                    </div>

                    <!-- Comida -->
                    <button class="side-clock flex flex-col items-center justify-center opacity-50 p-1.5 rounded-lg relative z-10 w-full h-full border-none hover:bg-bg hover:opacity-100 hover:scale-105 transition-all cursor-pointer" id="clockFoodContainer" onclick="window.app.openTimerEdit('food')" type="button">
                        <div class="text-[0.65rem] font-extrabold uppercase text-text-mute mb-1 flex items-center justify-center gap-1">
                            <i class="ph-bold ph-hamburger"></i> Comida <i class="ph-bold ph-pencil-simple text-brand text-[0.9em]"></i>
                        </div>
                        <div class="font-mono font-bold text-base text-text tabular-nums" id="dispFood">00:00</div>
                        <div class="text-[0.65rem] text-text-mute mt-0.5">/ <span id="limFood">45</span>m</div>
                        <div id="remFood" class="text-[0.7rem] font-extrabold mt-1 text-money">Restan: --</div>
                    </button>
                </div>

                <!-- Offline Display -->
                <div id="offlineDisplay" style="display:block;">
                    <div class="text-[0.7rem] uppercase tracking-widest text-text-mute font-extrabold mb-2.5">FUERA DE TURNO</div>
                    <div class="text-[clamp(2.5rem,12vw,4rem)] font-extrabold text-text-mute tabular-nums leading-none mb-5">--:--:--</div>
                </div>

                <!-- Botones de Acción -->
                <div class="grid grid-cols-2 gap-2.5 mt-4" id="actionButtons"></div>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Semanal -->
                <div class="bg-card border border-border rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2.5 pb-2 border-b border-border">
                        <div class="flex items-center gap-2">
                            <button class="bg-transparent border-none text-brand cursor-pointer text-base p-0 hover:text-white" onclick="window.app.changeWeek(-1)"><i class="ph-bold ph-caret-left"></i></button>
                            <span class="text-[0.9rem] font-extrabold text-text">Semana <span id="weekNum">--</span></span>
                            <button class="bg-transparent border-none text-brand cursor-pointer text-base p-0 hover:text-white" onclick="window.app.changeWeek(1)"><i class="ph-bold ph-caret-right"></i></button>
                        </div>
                        <span id="weekBalance" class="px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] bg-emerald-900/30 text-emerald-400">0h</span>
                    </div>
                    <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Meta</span><strong id="weekTarget" class="text-text">0:00</strong></div>
                    <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Trabajado</span><strong class="text-brand" id="weekWorked">0:00</strong></div>
                    <div class="flex justify-between items-center mt-2.5 pt-1.5 border-t border-dashed border-border text-[0.9rem]">
                        <span class="text-text-mute">Pago Extra</span><strong class="text-money" id="weekPay">$0</strong>
                    </div>
                </div>

                <!-- Quincenal -->
                <div class="bg-card border border-border rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2.5 pb-2 border-b border-border">
                        <span class="text-[0.9rem] font-extrabold text-text">Quincena <span id="qName">--</span></span>
                        <span id="qBalance" class="px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] bg-emerald-900/30 text-emerald-400">0h</span>
                    </div>
                    <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Meta</span><strong id="qTarget" class="text-text">0:00</strong></div>
                    <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Trabajado</span><strong class="text-brand" id="qWorked">0:00</strong></div>
                    <div class="flex justify-between items-center mt-2.5 text-[0.9rem]"><span class="text-alert">Faltas</span><strong class="text-alert" id="qFails">0</strong></div>
                </div>
            </div>

            <!-- LISTA HISTORIAL -->
            <div class="bg-card border border-border rounded-2xl overflow-hidden shadow-sm mb-6">
                <div class="px-5 py-4 bg-bg/50 font-extrabold text-text-mute text-[0.75rem] border-b border-border flex justify-between items-center tracking-wide">
                    <span id="logListTitle">HISTORIAL</span>
                    <button onclick="window.app.openModal()" class="border-none bg-transparent text-brand font-extrabold cursor-pointer hover:underline">+ MANUAL</button>
                </div>
                <div id="logList"></div>
            </div>
        </div>
    </div>


    <!-- BOTÓN SCROLL TO TOP -->
    <button id="scrollTopBtn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="fixed bottom-6 left-6 w-11 h-11 rounded-full bg-brand text-white shadow-lg shadow-brand/20 border border-white/10 z-50 flex items-center justify-center translate-y-20 opacity-0 transition-all duration-300 hover:scale-110 cursor-pointer">
        <i class="ph-bold ph-arrow-up text-xl"></i>
    </button>

    <!-- ==================== MODALES ==================== -->
    
    <!-- MENU DE NAVEGACION MOVIL -->
    <div class="modal fixed inset-0 w-screen h-screen z-[1000] hidden bg-black/80 backdrop-blur-sm" id="navModal" onclick="window.app.closeModalById('navModal')">
        <div class="absolute bottom-0 left-0 w-full bg-card rounded-t-2xl p-6 border-t border-border animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <span class="font-bold text-lg text-text">Navegación</span>
                 <button onclick="window.app.closeModalById('navModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 text-text-mute hover:text-text cursor-pointer"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="grid gap-3">
                <a href="#" class="p-3.5 rounded-xl bg-brand/10 text-brand border border-brand/20 font-extrabold flex items-center gap-3 text-sm tracking-wide">
                    <i class="ph-fill ph-check-circle text-lg"></i> ADHERENCIA
                </a>
                <a href="/corpo/finanzas.html" class="p-3.5 rounded-xl bg-input-bg border border-border hover:bg-white/5 text-text-mute hover:text-text font-bold flex items-center gap-3 transition-colors text-sm tracking-wide">
                    <i class="ph-bold ph-currency-dollar text-lg"></i> FINANZAS
                </a>
                <a href="/corpo/cuenta.html" class="p-3.5 rounded-xl bg-input-bg border border-border hover:bg-white/5 text-text-mute hover:text-text font-bold flex items-center gap-3 transition-colors text-sm tracking-wide">
                    <i class="ph-bold ph-user-circle text-lg"></i> CUENTA
                </a>
            </div>
        </div>
    </div>
    
    <!-- MENU CONFIGURACION -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="configModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[400px] max-h-[90vh] overflow-hidden flex flex-col border border-border shadow-2xl relative">
            <div class="p-4 border-b border-border flex justify-between items-center bg-bg/50 backdrop-blur-sm sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <i class="ph-fill ph-planet text-xl text-brand"></i>
                    <span class="font-bold text-text text-sm tracking-wide">CONFIGURACIÓN</span>
                </div>
                <button onclick="window.app.closeModalById('configModal')" class="text-text-mute hover:text-text transition-colors cursor-pointer">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-5 overflow-y-auto flex-1">
                <div class="flex p-1 bg-input-bg rounded-xl mb-6 border border-border/50">
                    <div class="tab active flex-1 text-center py-2 text-[0.75rem] font-bold cursor-pointer hover:text-text" onclick="window.app.switchTab('tSettings')">Ajustes</div>
                    <div class="tab flex-1 text-center py-2 text-[0.75rem] font-bold cursor-pointer hover:text-text" onclick="window.app.switchTab('tData')">Datos</div>
                </div>

                <div id="tSettings" class="tab-content active block animate-fade-in">
                    <div class="mb-6">
                        <p class="text-[0.65rem] font-black text-brand mb-3 uppercase tracking-wider flex items-center gap-1"><i class="ph-bold ph-clock"></i> Límites de Tiempo (Min)</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-input-bg p-3 rounded-xl border border-border">
                                <label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Baño</label>
                                <input type="number" id="cfgBath" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none placeholder-zinc-700">
                            </div>
                            <div class="bg-input-bg p-3 rounded-xl border border-border">
                                <label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Comida</label>
                                <input type="number" id="cfgFood" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none placeholder-zinc-700">
                            </div>
                        </div>
                    </div>
                    <div>
                        <p class="text-[0.65rem] font-black text-money mb-3 uppercase tracking-wider flex items-center gap-1"><i class="ph-bold ph-currency-dollar"></i> Configuración de Pagos</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-input-bg p-3 rounded-xl border border-border">
                                <label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Tarifa Base</label>
                                <input type="number" id="cfgRate1" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none placeholder-zinc-700">
                            </div>
                            <div class="bg-input-bg p-3 rounded-xl border border-border">
                                <label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Tarifa Extra</label>
                                <input type="number" id="cfgRate2" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none placeholder-zinc-700">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tData" class="tab-content hidden animate-fade-in">
                    <div class="space-y-3">
                        <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="window.app.openImportModal()">
                            <div class="w-10 h-10 rounded-lg bg-emerald-900/30 text-emerald-400 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="ph-bold ph-file-csv text-xl"></i></div>
                            <div><div class="text-sm text-text">Importar Excel</div><div class="text-[0.65rem] text-text-mute">Cargar datos masivos</div></div>
                        </button>
                        <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="window.app.exportBackup()">
                             <div class="w-10 h-10 rounded-lg bg-blue-900/30 text-blue-400 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="ph-bold ph-download-simple text-xl"></i></div>
                            <div><div class="text-sm text-text">Descargar Backup</div><div class="text-[0.65rem] text-text-mute">Guardar copia de seguridad</div></div>
                        </button>
                         <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="document.getElementById('importJsonInput').click()">
                            <div class="w-10 h-10 rounded-lg bg-violet-900/30 text-violet-400 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="ph-bold ph-upload-simple text-xl"></i></div>
                            <div><div class="text-sm text-text">Importar Backup (JSON)</div><div class="text-[0.65rem] text-text-mute">Restaurar desde archivo</div></div>
                        </button>
                        <input type="file" id="importJsonInput" accept=".json" class="hidden" onchange="window.app.importJson(this)">
                    </div>
                    <div class="border-t border-border my-6"></div>
                    <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-red-900 bg-red-900/10 text-red-500 hover:bg-red-900/20 transition-colors flex items-center justify-center gap-2" onclick="window.app.resetData()">
                        <i class="ph-bold ph-trash"></i> Reiniciar Aplicación
                    </button>
                </div>
            </div>
             <div class="p-4 border-t border-border bg-card">
                <button class="w-full bg-brand text-white p-3.5 rounded-xl font-extrabold cursor-pointer border-none hover:bg-blue-600 transition-colors shadow-lg shadow-brand/20" onclick="window.app.saveConfig()">
                    GUARDAR CAMBIOS
                </button>
            </div>
        </div>
    </div>

    <!-- LOG MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="logModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Registro Manual</h3>
            <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Fecha</label>
            <input type="date" id="inpDate" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text mb-2.5 [color-scheme:dark]">
            <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Tipo</label>
            <select id="inpType" onchange="window.app.toggleTimeInputs()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text mb-2.5">
                <option value="Laboral">Laboral</option>
                <option value="Descanso">Descanso</option>
                <option value="Falta">Falta</option>
                <option value="Vacaciones">Vacaciones</option>
            </select>
            <div id="timeInputs">
                <div class="grid grid-cols-2 gap-2.5 mb-2.5">
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Entrada</label><input type="time" id="inpIn" onchange="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text [color-scheme:dark]"></div>
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Salida</label><input type="time" id="inpOut" onchange="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text [color-scheme:dark]"></div>
                </div>
                <div class="bg-bg/50 p-2.5 rounded-lg mb-2.5 border border-border">
                    <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Minutos Reales:</label>
                    <div class="grid grid-cols-3 gap-1.5">
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Baño</label><input type="number" id="inpBathTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Comida</label><input type="number" id="inpFoodTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Pausa</label><input type="number" id="inpPauseTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                    </div>
                </div>
                <p class="text-right text-text-mute text-sm">Neto Calculado: <strong id="calcHoursDisplay" class="text-text">0:00</strong></p>
            </div>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-brand text-white hover:bg-blue-600 transition-colors mt-4" onclick="window.app.saveLog()">Guardar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer mb-2.5 text-alert border border-alert bg-transparent hidden hover:bg-alert/10" id="btnDelete" onclick="window.app.deleteLog()">Eliminar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.closeModalById('logModal')">Cancelar</button>
        </div>
    </div>

    <!-- CLOCK OUT MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="clockOutModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border text-center">
            <h3 class="text-text font-bold text-lg mb-4">¿Terminar Turno?</h3>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-alert text-white mt-4 mb-2.5 hover:bg-red-600 transition-colors" onclick="window.app.finishShiftReal()">TERMINAR</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.cancelClockOut()">Cancelar</button>
        </div>
    </div>

    <!-- EDITAR TIEMPO MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="timerEditModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Ajustar Tiempo</h3>
            <p class="text-sm mb-2.5 text-text-mute">
                Ingresa el tiempo acumulado para <strong id="timerEditTitle" class="text-text">--</strong>.
                <br><span class="text-xs">(Formatos aceptados: "15", "3.5" o "3:14")</span>
            </p>
            <input type="text" id="inpTimerEdit" placeholder="Ej. 3:14" class="text-lg text-center bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text">
            <div class="flex gap-2.5 mt-4">
                <button class="flex-1 bg-brand text-white p-3 rounded-lg font-extrabold cursor-pointer border-none hover:bg-blue-600 transition-colors" onclick="window.app.saveTimerEdit()">Actualizar</button>
                <button class="flex-1 bg-transparent border border-border text-text-mute p-3 rounded-lg font-extrabold cursor-pointer hover:text-text hover:bg-white/5" onclick="window.app.closeModalById('timerEditModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- UTILS MODALS -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="msgModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border text-center">
            <i id="msgIcon" class="text-[2.5rem] mb-2.5 block"></i>
            <p id="msgText" class="font-bold mb-5 text-text"></p>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-brand text-white hover:bg-blue-600 transition-colors" onclick="window.app.closeModalById('msgModal')">OK</button>
        </div>
    </div>
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="importModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Importar Excel</h3>
            <textarea id="importTextArea" rows="6" class="font-mono text-xs w-full bg-input-bg border border-border p-2.5 rounded-lg text-text mb-4 placeholder-zinc-700" placeholder="Pegar CSV aquí..."></textarea>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-brand text-white hover:bg-blue-600 transition-colors" onclick="window.app.processImport()">Procesar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.closeModalById('importModal')">Cancelar</button>
        </div>
    </div>

    <!-- LOGICA UNIFICADA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where,
            setPersistence, browserLocalPersistence
        };

        const firebaseConfig = {
            apiKey: "AIzaSyC-cUzYmh5G9y_W2RXbO1Uma4DlKKmnnss",
            authDomain: "odsplan-adherencia.firebaseapp.com",
            projectId: "godsplan-adherencia",
            storageBucket: "godsplan-adherencia.firebasestorage.app",
            messagingSenderId: "660801277434",
            appId: "1:660801277434:web:3a37ece56538dc2b22a843"
        };

        let auth, db;
        // Updated error handler with safe access
        function showGlobalError(m) { 
            const x = document.getElementById('msgModal'); 
            if (x) { 
                const txt = document.getElementById('msgText');
                if(txt) txt.textContent = m; 
                document.getElementById('msgIcon').className = 'ph-fill ph-warning-circle text-alert'; 
                x.classList.remove('hidden'); x.classList.add('flex'); 
            } else alert(m); 
        }
        window.onerror = function (m) { if (!String(m).includes('popup')) showGlobalError(m); };

        try { 
            const fbApp = initializeApp(firebaseConfig); 
            auth = getAuth(fbApp); 
            setPersistence(auth, browserLocalPersistence).catch(console.error);
            db = getFirestore(fbApp); 
        } catch (e) { setTimeout(() => showGlobalError(e.message), 1000); }

        window.app = {
            data: { logs: [], config: { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 }, activeShift: null },
            userId: null, offline: false, editingId: null, date: new Date(), timer: null, processing: false, 
            editingTimerType: null, timeOffset: 0, lastSync: 0, isSyncing: false, isRegistering: false,

            init() {
                this.updateRealClockUI();
                setInterval(() => this.updateRealClockUI(), 1000);

                // Scroll to top button logic
                window.addEventListener('scroll', () => {
                    const btn = document.getElementById('scrollTopBtn');
                    if (btn) {
                        if (window.scrollY > 300) {
                            btn.classList.remove('translate-y-20', 'opacity-0');
                        } else {
                            btn.classList.add('translate-y-20', 'opacity-0');
                        }
                    }
                });
                
                if (!auth) return this.goOffline();

                onAuthStateChanged(auth, async u => {
                    if (u) { 
                        // USUARIO LOGUEADO -> MUESTRA APP
                        this.userId = u.uid; 
                        this.offline = false; 
                        this.renderAuth(u);
                        
                        const loginView = document.getElementById('login-view');
                        if(loginView) loginView.classList.add('hidden');
                        
                        const appView = document.getElementById('app-view');
                        if(appView) {
                            appView.classList.remove('hidden');
                            setTimeout(() => appView.classList.add('animate-fade-in'), 50);
                        }

                        await this.load(); 
                    } else {
                        // USUARIO NO LOGUEADO -> MUESTRA LOGIN
                        this.userId = null;
                        const appView = document.getElementById('app-view');
                        if(appView) {
                            appView.classList.add('hidden');
                            appView.classList.remove('animate-fade-in');
                        }
                        
                        const loginView = document.getElementById('login-view');
                        if(loginView) loginView.classList.remove('hidden');
                        
                        this.data = { logs: [], config: { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 }, activeShift: null };
                    }
                    this.loadLocal(); 
                });
            },

            // --- HELPER PARA EVITAR ERRORES DE DOM ---
            setText(id, text) {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            },

            // --- FUNCIONES DE AUTENTICACIÓN (NUEVAS) ---

            toggleAuth(mode) {
                this.isRegistering = (mode === 'register');
                const container = document.getElementById('auth-switch-container');
                const nameField = document.getElementById('field-name');
                const errorMsg = document.getElementById('auth-error-msg');
                
                const tabLogin = document.getElementById('tab-login');
                const tabRegister = document.getElementById('tab-register');

                if(tabLogin) tabLogin.classList.toggle('active', !this.isRegistering);
                if(tabRegister) tabRegister.classList.toggle('active', this.isRegistering);
                if(container) container.classList.toggle('auth-mode-register', this.isRegistering);
                if(errorMsg) errorMsg.classList.add('hidden');

                if(this.isRegistering) {
                    this.setText('btn-text', "CREAR CUENTA");
                    if(nameField) nameField.classList.remove('hidden');
                } else {
                    this.setText('btn-text', "INICIAR SESIÓN");
                    if(nameField) nameField.classList.add('hidden');
                }
            },

            async handleAuthSubmit() {
                const btn = document.getElementById('btn-submit');
                const errMsg = document.getElementById('auth-error-msg');
                
                const idInput = document.getElementById('input-id');
                const passInput = document.getElementById('input-pass');
                const nameInput = document.getElementById('input-name');

                let id = idInput ? idInput.value.trim() : '';
                const pass = passInput ? passInput.value : '';
                const name = nameInput ? nameInput.value.trim() : '';

                if (!id || !pass) return this.showAuthError("Completa todos los campos");
                if (this.isRegistering && !name) return this.showAuthError("El nombre es obligatorio");

                if (!id.includes('@')) id = `${id}@godsplan.site`;

                if(btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> PROCESANDO...';
                }
                if(errMsg) errMsg.classList.add('hidden');

                try {
                    if (this.isRegistering) {
                        const userCredential = await createUserWithEmailAndPassword(auth, id, pass);
                        await updateProfile(userCredential.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(auth, id, pass);
                    }
                } catch (error) {
                    console.error(error);
                    this.showAuthError(this.mapAuthError(error.code));
                    if(btn) {
                        btn.disabled = false;
                        btn.innerHTML = `<span>${this.isRegistering ? 'CREAR CUENTA' : 'INICIAR SESIÓN'}</span> <i class="ph-bold ph-arrow-right"></i>`;
                    }
                }
            },

            async loginGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google Error:", error);
                    this.showAuthError("Error con Google. Intenta más tarde.");
                }
            },

            showAuthError(msg) {
                const errMsg = document.getElementById('auth-error-msg');
                this.setText('auth-error-txt', msg);
                if(errMsg) errMsg.classList.remove('hidden');
                
                const btn = document.getElementById('btn-submit');
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<span>${this.isRegistering ? 'CREAR CUENTA' : 'INICIAR SESIÓN'}</span> <i class="ph-bold ph-arrow-right"></i>`;
                }
            },

            mapAuthError(code) {
                switch(code) {
                    case 'auth/email-already-in-use': return "Este ID/Email ya está registrado.";
                    case 'auth/invalid-email': return "Formato de ID inválido.";
                    case 'auth/user-not-found': return "Usuario no encontrado.";
                    case 'auth/wrong-password': return "Contraseña incorrecta.";
                    case 'auth/weak-password': return "La contraseña debe tener al menos 6 caracteres.";
                    default: return "Error: " + code.split('/')[1];
                }
            },

            // --- FUNCIONES DE APP EXISTENTE ---

            updateRealClockUI() {
                const now = new Date();
                let displayTime = now.toLocaleTimeString();
                try {
                    displayTime = new Intl.DateTimeFormat('es-MX', {
                        timeZone: 'America/Mexico_City',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    }).format(now);
                } catch (e) {}
                this.setText('realClockTime', displayTime);
            },

            getNow() { return Date.now() + this.timeOffset; },

            getCDMXDate(ms) { return new Date(ms).toLocaleDateString('en-CA', { timeZone: 'America/Mexico_City' }); },

            getCDMXTime(ms) {
                return new Date(ms).toLocaleTimeString('es-MX', { 
                    timeZone: 'America/Mexico_City', hour: '2-digit', minute: '2-digit', hour12: false 
                }).slice(0, 5);
            },

            goOffline() { 
                this.offline = true; 
                this.loadLocal(); 
            },
            
            renderAuth(u) {
                const isRealUser = u && !u.isAnonymous;
                let t = u ? (u.isAnonymous ? "ANÓNIMO" : (u.displayName || "Usuario")) : "DESCONECTADO";
                if (isRealUser && u.email && u.email.includes('@godsplan.site')) t = u.email.split('@')[0];
                this.setText('user-name', t);
            },

            loadLocal() { const d = localStorage.getItem('godsPlanData'); if (d) { try { this.data = JSON.parse(d); this.render(); this.uiClock(); } catch (e) { } } },
            
            async load() {
                if (this.offline || !this.userId) return;
                try {
                    const docRef = doc(db, "users", this.userId, "attendance", "sync_state");
                    const snap = await getDoc(docRef);
                    if (snap.exists()) { 
                        this.data = snap.data(); 
                        this.data.logs = this.data.logs || []; 
                        this.data.config = this.data.config || { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 };
                    } else if (auth.currentUser.isAnonymous) { 
                        const l = localStorage.getItem('godsPlanData'); 
                        if (l) { this.data = JSON.parse(l); this.save(); } 
                    }
                    this.render(); this.uiClock();
                } catch (e) { console.error(e); }
            },
            
            async save() {
                localStorage.setItem('godsPlanData', JSON.stringify(this.data));
                if (!this.offline && this.userId) {
                    const docRef = doc(db, "users", this.userId, "attendance", "sync_state");
                    await setDoc(docRef, this.data);
                }
            },
            
            syncData() { this.load(); this.showSuccess("Sincronizado"); },
            
            uiClock() {
                const s = this.data.activeShift;
                const area = document.getElementById('actionButtons');
                const off = document.getElementById('offlineDisplay');
                const on = document.getElementById('timersDisplay');
                const config = this.data.config || {}; 
                const bl = config.bathAllow || 15;
                const fl = config.foodAllow || 45;

                const btnBase = "btn-ctrl h-[55px] rounded-lg font-extrabold text-[0.85rem] cursor-pointer flex flex-col items-center justify-center gap-0.5 uppercase transition-all relative overflow-hidden active:scale-95";
                const btnStart = `${btnBase} col-span-2 text-lg h-[70px] text-white bg-gradient-to-br from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 border-none`;
                const btnStop = `${btnBase} col-span-2 text-white bg-gradient-to-br from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 border-none`;
                
                const btnBath = `${btnBase} bg-card text-text-mute border-2 border-blue-500/40 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-500/10`;
                const btnFood = `${btnBase} bg-card text-text-mute border-2 border-amber-500/40 hover:border-amber-500 hover:text-amber-500 hover:bg-amber-500/10`;
                const btnPause = `${btnBase} col-span-2 bg-card text-text-mute border-2 border-orange-600/40 hover:border-orange-500 hover:text-orange-500 hover:bg-orange-500/10`;

                const startEl = document.getElementById('shiftStartTime');

                if (!s) {
                    if(off) off.style.display = 'block'; 
                    if(on) on.style.display = 'none';
                    if(area) area.innerHTML = `<button class="${btnStart}" onclick="window.app.clockIn()"><i class="ph-bold ph-play"></i> INICIAR JORNADA</button>`;
                    if (this.timer) clearInterval(this.timer);
                    this.setText('clockStatus', "FUERA DE TURNO");
                    const cs = document.getElementById('clockStatus');
                    if(cs) {
                        cs.classList.remove('animate-pulse-custom');
                        cs.classList.remove('text-warn');
                    }
                    if(startEl) startEl.style.display = 'none';
                } else {
                    if (!s.breaks) { s.breaks = { bathroom: 0, food: 0, pause: 0 }; this.save(); }
                    if (s.breaks.pause === undefined) s.breaks.pause = 0;

                    if(off) off.style.display = 'none'; 
                    if(on) on.style.display = 'grid';
                    this.setText('limBath', bl);
                    this.setText('limFood', fl);
                    const bathEl = document.getElementById('clockBathContainer');
                    const foodEl = document.getElementById('clockFoodContainer');
                    
                    if(startEl && s.start) {
                        startEl.textContent = `ENTRADA: ${this.getCDMXTime(s.start)}`;
                        startEl.style.display = 'block';
                    }

                    if(area) {
                        area.innerHTML = `
                            <button class="${btnBath} ${s.breakType === 'bathroom' ? 'active-bath' : ''}" onclick="window.app.toggleBreak('bathroom')"><i class="ph-bold ph-toilet"></i> BAÑO</button>
                            <button class="${btnFood} ${s.breakType === 'food' ? 'active-food' : ''}" onclick="window.app.toggleBreak('food')"><i class="ph-bold ph-hamburger"></i> COMIDA</button>
                            <button class="${btnPause} ${s.breakType === 'pause' ? 'active-pause' : ''}" onclick="window.app.toggleBreak('pause')"><i class="ph-bold ph-pause-circle"></i> ${s.breakType === 'pause' ? 'REANUDAR' : 'PAUSAR / DESCONEXIÓN'}</button>
                            <button class="${btnStop}" onclick="window.app.confirmClockOut()"><i class="ph-bold ph-stop"></i> TERMINAR JORNADA</button>
                        `;
                    }

                    if (this.timer) clearInterval(this.timer);
                    this.timer = setInterval(() => {
                        const now = this.getNow();
                        
                        let totalPauseAccumulated = (s.breaks.pause || 0) * 60000;
                        let currentPauseDuration = 0;
                        
                        const cs = document.getElementById('clockStatus');

                        if (s.breakType === 'pause') {
                            this.setText('clockStatus', "PAUSADO");
                            if(cs) {
                                cs.classList.add('animate-pulse-custom');
                                cs.classList.add('text-warn');
                            }
                            currentPauseDuration = now - s.breakStart;
                        } else {
                            this.setText('clockStatus', "TURNO ACTIVO");
                            if(cs) {
                                cs.classList.remove('animate-pulse-custom');
                                cs.classList.remove('text-warn');
                            }
                        }

                        let displayTime = (now - s.start) - totalPauseAccumulated - currentPauseDuration;
                        this.setText('clockDisplay', this.msToTime(displayTime));

                        let b = s.breaks.bathroom || 0, f = s.breaks.food || 0;
                        if (s.breakStart) {
                            const d = (now - s.breakStart) / 60000;
                            if (s.breakType === 'bathroom') b += d; else if (s.breakType === 'food') f += d;
                        }
                        
                        this.setText('dispBath', this.fmtBreak(b));
                        if(bathEl) {
                            if (s.breakType === 'bathroom') bathEl.classList.add('active'); else bathEl.classList.remove('active');
                            if (b > bl) bathEl.classList.add('danger'); else bathEl.classList.remove('danger');
                        }

                        const bathRem = (config.bathAllow || 15) - b;
                        const elRemBath = document.getElementById('remBath');
                        if (elRemBath) {
                            elRemBath.textContent = bathRem >= 0 ? `Restan: ${this.fmtBreak(bathRem)}` : `Exceso: ${this.fmtBreak(Math.abs(bathRem))}`;
                            elRemBath.className = bathRem >= 0 ? 'text-[0.7rem] font-extrabold mt-1 text-money' : 'text-[0.7rem] font-extrabold mt-1 text-alert';
                        }

                        this.setText('dispFood', this.fmtBreak(f));
                        if(foodEl) {
                            if (s.breakType === 'food') foodEl.classList.add('active'); else foodEl.classList.remove('active');
                            if (f > fl) foodEl.classList.add('danger'); else foodEl.classList.remove('danger');
                        }

                        const foodRem = (config.foodAllow || 45) - f;
                        const elRemFood = document.getElementById('remFood');
                        if (elRemFood) {
                            elRemFood.textContent = foodRem >= 0 ? `Restan: ${this.fmtBreak(foodRem)}` : `Exceso: ${this.fmtBreak(Math.abs(foodRem))}`;
                            elRemFood.className = foodRem >= 0 ? 'text-[0.7rem] font-extrabold mt-1 text-money' : 'text-[0.7rem] font-extrabold mt-1 text-alert';
                        }
                    }, 1000);
                }
            },
            
            openTimerEdit(type) {
                if (!this.data.activeShift) return;
                this.editingTimerType = type;
                let currentTotal = this.data.activeShift.breaks[type] || 0;
                if (this.data.activeShift.breakStart && this.data.activeShift.breakType === type) {
                    currentTotal += (this.getNow() - this.data.activeShift.breakStart) / 60000;
                }
                this.setText('timerEditTitle', type === 'bathroom' ? 'Baño' : 'Comida');
                const m = Math.floor(currentTotal);
                const s = Math.floor((currentTotal % 1) * 60);
                const inp = document.getElementById('inpTimerEdit');
                if(inp) inp.value = `${m}:${s.toString().padStart(2, '0')}`; 
                const modal = document.getElementById('timerEditModal');
                if(modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
                if(inp) setTimeout(() => inp.focus(), 100);
            },

            saveTimerEdit() {
                if (!this.editingTimerType || !this.data.activeShift) return;
                const inp = document.getElementById('inpTimerEdit');
                const valStr = inp ? inp.value.trim() : '0';
                let newVal = 0;
                if (valStr.includes(':')) {
                    const parts = valStr.split(':');
                    newVal = (parseInt(parts[0]) || 0) + ((parseInt(parts[1]) || 0) / 60);
                } else newVal = parseFloat(valStr);
                
                if (isNaN(newVal) || newVal < 0) return this.showMessage("Tiempo inválido");

                if (this.data.activeShift.breakStart && this.data.activeShift.breakType === this.editingTimerType) {
                    this.data.activeShift.breaks[this.editingTimerType] = newVal;
                    this.data.activeShift.breakStart = this.getNow();
                } else {
                    this.data.activeShift.breaks[this.editingTimerType] = newVal;
                }
                this.save(); this.uiClock();
                const modal = document.getElementById('timerEditModal');
                if(modal) {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }
            },

            clockIn() {
                if (this.processing) return; this.processing = true;
                this.stopBreak();
                this.data.activeShift = { start: this.getNow(), breaks: { bathroom: 0, food: 0, pause: 0 }, breakStart: null, breakType: null };
                this.save(); this.uiClock(); this.processing = false;
            },
            toggleBreak(type) {
                const s = this.data.activeShift; if (!s) return;
                if (s.breakStart) {
                    const prev = s.breakType;
                    this.stopBreak();
                    if (prev !== type) setTimeout(() => this.startBreak(type), 50);
                } else this.startBreak(type);
            },
            startBreak(t) { 
                this.data.activeShift.breakStart = this.getNow(); 
                this.data.activeShift.breakType = t; 
                this.save(); this.uiClock(); 
            },
            stopBreak() {
                const s = this.data.activeShift;
                if (s && s.breakStart) {
                    if (s.breakType) {
                        if (s.breaks[s.breakType] === undefined) s.breaks[s.breakType] = 0;
                        s.breaks[s.breakType] += (this.getNow() - s.breakStart) / 60000;
                    }
                    s.breakStart = null; s.breakType = null;
                    this.save(); this.uiClock();
                }
            },
            confirmClockOut() {
                if (this.data.activeShift.breakStart) this.stopBreak();
                if (this.data.activeShift) {
                    const m = document.getElementById('clockOutModal');
                    if(m) {
                        m.classList.remove('hidden');
                        m.classList.add('flex');
                    }
                }
            },
            finishShiftReal() {
                const s = this.data.activeShift;
                if (!s) return;
                if (s.breakStart) this.stopBreak(); 
                if (!s.breaks) s.breaks = { bathroom: 0, food: 0, pause: 0 };
                
                const end = this.getNow();
                const totalWallTime = (end - s.start) / 60000;
                const pauseTime = s.breaks.pause || 0;
                const gross = totalWallTime - pauseTime;
                
                const b = s.breaks.bathroom || 0, f = s.breaks.food || 0;
                const config = this.data.config || {}; 
                const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                
                const logDate = this.getCDMXDate(s.start);
                const logIn = this.getCDMXTime(s.start);
                const logOut = this.getCDMXTime(end);

                this.data.logs.push({
                    id: this.getNow(), 
                    date: logDate, 
                    type: 'Laboral',
                    in: logIn, 
                    out: logOut, 
                    hours: gross, 
                    disconnection: disc,
                    details: { bath: b, food: f, pause: pauseTime }
                });
                this.data.activeShift = null;
                this.save(); this.render(); this.uiClock();
                const m = document.getElementById('clockOutModal');
                if(m) {
                    m.classList.remove('flex');
                    m.classList.add('hidden');
                }
            },
            cancelClockOut() { 
                const m = document.getElementById('clockOutModal');
                if(m) {
                    m.classList.remove('flex'); 
                    m.classList.add('hidden'); 
                }
            },

            render() {
                const d = this.date, m = d.getMonth(), y = d.getFullYear();
                this.setText('monthLabel', `${["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"][m]} ${y}`);
                const wn = this.getWeek(d);
                this.setText('weekNum', wn);

                const wLogs = this.data.logs.filter(l => this.getWeek(new Date(l.date + 'T00:00')) === wn && new Date(l.date).getFullYear() === y);
                const wRes = this.calcStats(wLogs);
                this.setText('weekTarget', this.fmt(wRes.target));
                this.setText('weekWorked', this.fmt(wRes.worked));
                this.setBadge('weekBalance', wRes.bal);
                const config = this.data.config || {}; 
                let pay = 0, he = Math.floor(wRes.bal / 60);
                if (wRes.bal > 0) pay = (he <= 12) ? he * (config.rate1 || 50) : (12 * (config.rate1 || 50)) + ((he - 12) * (config.rate1 || 50));
                this.setText('weekPay', `$${Math.round(pay)}`);

                const isQ1 = d.getDate() <= 15;
                this.setText('qName', isQ1 ? 'Q1' : 'Q2');
                const qLogs = this.data.logs.filter(l => { const x = new Date(l.date + 'T00:00'); return x.getMonth() === m && (isQ1 ? x.getDate() <= 15 : x.getDate() > 15); });
                const qRes = this.calcStats(qLogs);
                this.setText('qTarget', this.fmt(qRes.target));
                this.setText('qWorked', this.fmt(qRes.worked));
                this.setBadge('qBalance', qRes.bal);
                this.setText('qFails', qRes.fails);

                const list = document.getElementById('logList'); 
                if(list) {
                    list.innerHTML = '';
                    const mLogs = this.data.logs.filter(l => new Date(l.date + 'T00:00').getMonth() === m).sort((a, b) => new Date(b.date) - new Date(a.date));
                    mLogs.forEach(l => {
                        const x = new Date(l.date + 'T00:00');
                        const net = (l.type === 'Laboral' || l.type === 'Descanso') ? (l.hours - (l.disconnection || 0)) : 0;
                        const bal = net - ((l.type === 'Laboral' || l.type === 'Falta') ? 480 : 0);
                        let chips = '';
                        if (l.details) {
                            const pillClass = "px-1.5 py-0.5 rounded flex items-center gap-1 font-semibold text-[0.7rem] border border-border bg-bg/50 text-text-mute";
                            const excessClass = "bg-red-900/40 text-red-300 border-red-900";

                            if (l.details.bath > 0) chips += `<span class="${pillClass} ${l.details.bath > (config.bathAllow || 15) ? excessClass : ''}"><i class="ph-bold ph-toilet"></i> ${Math.round(l.details.bath)}m</span>`;
                            if (l.details.food > 0) chips += `<span class="${pillClass} ${l.details.food > (config.foodAllow || 45) ? excessClass : ''}"><i class="ph-bold ph-hamburger"></i> ${Math.round(l.details.food)}m</span>`;
                            if (l.details.pause > 0) chips += `<span class="${pillClass} text-warn border-warn"><i class="ph-bold ph-pause-circle"></i> ${Math.round(l.details.pause)}m</span>`;
                        }
                        const hourText = (l.type === 'Laboral' || (l.type === 'Descanso' && l.hours > 0)) ? `${l.in ? l.in + '-' + l.out + ' • ' : ''}<b>${this.fmt(net)}</b>` : '';

                        let tagClass = "px-2.5 py-1 rounded-md text-[0.7rem] font-extrabold uppercase inline-flex items-center justify-center leading-none tracking-wide ";
                        if(l.type === 'Laboral') tagClass += "bg-blue-900/30 text-blue-200";
                        else if(l.type === 'Descanso') tagClass += "bg-slate-800 text-slate-300 border border-white/5";
                        else if(l.type === 'Falta') tagClass += "bg-red-900/30 text-red-200";
                        else if(l.type === 'Vacaciones') tagClass += "bg-amber-900/30 text-amber-200";

                        const balClass = bal >= 0 ? "bg-emerald-900/30 text-emerald-300" : "bg-red-900/30 text-red-300";

                        const html = `
                        <div class="bg-card border border-border rounded-lg text-center py-1.5 flex flex-col items-center justify-center">
                            <div class="text-base font-extrabold text-text leading-none mb-0.5">${x.getDate()}</div>
                            <div class="text-[0.65rem] uppercase text-text-mute font-bold">${['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][x.getDay()]}</div>
                        </div>
                        <div class="flex flex-col gap-1.5">
                            <div class="flex items-center text-[0.85rem] font-semibold text-text"><span class="${tagClass}">${l.type}</span></div>
                            ${hourText ? `<div class="text-[0.8rem] text-text-mute flex gap-2 items-center font-medium">${hourText}</div>` : ''}
                            <div class="flex gap-1.5 flex-wrap text-[0.7rem]">${chips}</div>
                        </div>
                        <div class="text-center font-extrabold text-[0.8rem] px-2 py-1 rounded-md justify-self-end min-w-[60px] ${balClass}">${bal > 0 ? '+' : ''}${this.fmt(bal)}</div>`;
                        const div = document.createElement('div'); 
                        div.className = 'p-4 border-b border-border grid grid-cols-[45px_1fr_auto] gap-4 items-center hover:bg-white/5 transition-colors cursor-pointer last:border-b-0'; 
                        div.onclick = () => window.app.openModal(l.id); 
                        div.innerHTML = html;
                        list.appendChild(div);
                    });
                }
            },

            calcStats(logs) { let t = 0, w = 0, f = 0; logs.forEach(l => { t += (l.type === 'Laboral' || l.type === 'Falta') ? 480 : 0; w += (l.type === 'Laboral' || l.type === 'Descanso') ? (l.hours - (l.disconnection || 0)) : 0; if (l.type === 'Falta') f++; }); return { target: t, worked: w, bal: w - t, fails: f }; },
            fmt(m) { const a = Math.abs(m); return `${m < 0 ? '-' : ''}${Math.floor(a / 60)}:${Math.floor(a % 60).toString().padStart(2, '0')}`; },
            fmtBreak(m) { return `${Math.floor(m).toString().padStart(2, '0')}:${Math.floor((m % 1) * 60).toString().padStart(2, '0')}`; },
            msToTime(ms) { const s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60); return `${h}:${(m % 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`; },
            getWeek(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var y = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - y) / 86400000) + 1) / 7); },
            setBadge(id, v) { 
                const e = document.getElementById(id); 
                if(e) {
                    e.textContent = (v > 0 ? '+' : '') + this.fmt(v); 
                    e.className = `px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] ${v >= 0 ? 'bg-emerald-900/30 text-emerald-300' : 'bg-red-900/30 text-red-300'}`; 
                }
            },
            changeMonth(n) { this.date.setMonth(this.date.getMonth() + n); this.date.setDate(1); this.render(); },
            changeWeek(n) { this.date.setDate(this.date.getDate() + (n * 7)); this.render(); },
            goToday() { this.date = new Date(); this.render(); },

            openConfigModal() { 
                const m = document.getElementById('configModal');
                if(m) { m.classList.remove('hidden'); m.classList.add('flex'); }
                const inpBath = document.getElementById('cfgBath');
                const inpFood = document.getElementById('cfgFood');
                const inpRate1 = document.getElementById('cfgRate1');
                const inpRate2 = document.getElementById('cfgRate2');
                
                if(inpBath) inpBath.value = this.data.config.bathAllow || 15; 
                if(inpFood) inpFood.value = this.data.config.foodAllow || 45; 
                if(inpRate1) inpRate1.value = this.data.config.rate1; 
                if(inpRate2) inpRate2.value = this.data.config.rate2; 
                
                this.switchTab('tSettings'); 
            },
            openNavModal() {
                 const m = document.getElementById('navModal');
                 if(m) {
                     m.classList.remove('hidden');
                     m.classList.add('flex');
                 }
            },
            saveConfig() { 
                const inpBath = document.getElementById('cfgBath');
                const inpFood = document.getElementById('cfgFood');
                const inpRate1 = document.getElementById('cfgRate1');
                const inpRate2 = document.getElementById('cfgRate2');

                this.data.config.bathAllow = inpBath ? (parseFloat(inpBath.value) || 15) : 15; 
                this.data.config.foodAllow = inpFood ? (parseFloat(inpFood.value) || 45) : 45; 
                this.data.config.rate1 = inpRate1 ? (parseFloat(inpRate1.value) || 50) : 50; 
                this.data.config.rate2 = inpRate2 ? (parseFloat(inpRate2.value) || 75) : 75; 
                this.save(); 
                this.closeModalById('configModal'); 
            },
            switchTab(id) { 
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); 
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active', 'block')); 
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); 
                if(event && event.target) event.target.classList.add('active'); 
                const el = document.getElementById(id);
                if(el) {
                    el.classList.add('active', 'block'); 
                    el.classList.remove('hidden'); 
                }
            },
            
            logout() { signOut(auth).then(() => window.location.reload()); }, 
            
            resetData() { if (confirm("¿Borrar todo?")) { this.data = { logs: [], config: this.data.config, activeShift: null }; this.save(); location.reload(); } },

            openModal(id = null) {
                this.editingId = id; 
                const m = document.getElementById('logModal');
                if(m) {
                    m.classList.remove('hidden');
                    m.classList.add('flex');
                }

                const now = new Date().toISOString().split('T')[0];
                const inpDate = document.getElementById('inpDate');
                const inpType = document.getElementById('inpType');
                const inpIn = document.getElementById('inpIn');
                const inpOut = document.getElementById('inpOut');
                const inpBath = document.getElementById('inpBathTime');
                const inpFood = document.getElementById('inpFoodTime');
                const inpPause = document.getElementById('inpPauseTime');

                if(inpDate) inpDate.value = now; 
                if(inpType) inpType.value = 'Laboral';
                if(inpIn) inpIn.value = ''; 
                if(inpOut) inpOut.value = '';
                if(inpBath) inpBath.value = 0; 
                if(inpFood) inpFood.value = 0;
                if(inpPause) inpPause.value = 0;

                const btnDel = document.getElementById('btnDelete');
                if (id) {
                    if(btnDel) btnDel.classList.remove('hidden');
                    const l = this.data.logs.find(x => x.id === id);
                    if(l) {
                        if(inpDate) inpDate.value = l.date; 
                        if(inpType) inpType.value = l.type;
                        if(inpIn) inpIn.value = l.in; 
                        if(inpOut) inpOut.value = l.out;
                        if (l.details) { 
                            if(inpBath) inpBath.value = Math.round(l.details.bath); 
                            if(inpFood) inpFood.value = Math.round(l.details.food); 
                            if(inpPause) inpPause.value = l.details.pause ? Math.round(l.details.pause) : 0;
                        }
                    }
                } else {
                    if(btnDel) btnDel.classList.add('hidden');
                }
                this.toggleTimeInputs();
            },
            toggleTimeInputs() { 
                const typeEl = document.getElementById('inpType');
                const timeInputs = document.getElementById('timeInputs');
                if(typeEl && timeInputs) {
                    timeInputs.style.display = (typeEl.value === 'Falta' || typeEl.value === 'Vacaciones') ? 'none' : 'block'; 
                }
            },
            calcPreview() { 
                const inpIn = document.getElementById('inpIn');
                const inpOut = document.getElementById('inpOut');
                const inpBath = document.getElementById('inpBathTime');
                const inpFood = document.getElementById('inpFoodTime');
                const inpPause = document.getElementById('inpPauseTime');

                const i = inpIn ? inpIn.value : '';
                const o = inpOut ? inpOut.value : '';
                const b = inpBath ? (parseFloat(inpBath.value) || 0) : 0;
                const f = inpFood ? (parseFloat(inpFood.value) || 0) : 0;
                const p = inpPause ? (parseFloat(inpPause.value) || 0) : 0; 

                const g = this.calcHours(i, o);
                const config = this.data.config || {};
                const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                
                this.setText('calcHoursDisplay', g === -1 ? 'Error' : this.fmt(g - p - disc));
            },
            saveLog() {
                const inpDate = document.getElementById('inpDate');
                const inpType = document.getElementById('inpType');
                const inpIn = document.getElementById('inpIn');
                const inpOut = document.getElementById('inpOut');
                const inpBath = document.getElementById('inpBathTime');
                const inpFood = document.getElementById('inpFoodTime');
                const inpPause = document.getElementById('inpPauseTime');

                const d = inpDate ? inpDate.value : '';
                const t = inpType ? inpType.value : 'Laboral';
                const i = inpIn ? inpIn.value : '';
                const o = inpOut ? inpOut.value : '';
                const b = inpBath ? (parseFloat(inpBath.value) || 0) : 0;
                const f = inpFood ? (parseFloat(inpFood.value) || 0) : 0;
                const p = inpPause ? (parseFloat(inpPause.value) || 0) : 0;

                if (!d) return this.showMessage("Fecha requerida");
                let h = 0, disc = 0; 
                
                if (t === 'Laboral') {
                    if (!i || !o) return this.showMessage("Laboral requiere entrada y salida");
                    h = this.calcHours(i, o) - p; 
                    if (h <= 0) return this.showMessage("Horario inválido o pausa excede turno"); 
                } else if (t === 'Descanso') {
                    if (i && o) {
                        h = this.calcHours(i, o) - p;
                        if (h < 0) return this.showMessage("Horario inválido");
                    } else {
                        h = 0;
                    }
                }

                if (t === 'Laboral' || (t === 'Descanso' && h > 0)) {
                        const config = this.data.config || {};
                        const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                }

                const log = { id: this.editingId || this.getNow(), date: d, type: t, in: i || '', out: o || '', hours: h, disconnection: disc, details: { bath: b, food: f, pause: p } };
                if (this.editingId) this.data.logs[this.data.logs.findIndex(x => x.id === this.editingId)] = log; else this.data.logs.push(log);
                this.save(); this.render(); 
                this.closeModalById('logModal');
            },
            deleteLog() { if (confirm("¿Eliminar?")) { this.data.logs = this.data.logs.filter(x => x.id !== this.editingId); this.save(); this.render(); this.closeModalById('logModal'); } },
            
            closeModalById(id) {
                const m = document.getElementById(id);
                if(m) {
                    m.classList.remove('flex');
                    m.classList.add('hidden');
                }
            },

            showMessage(m) { 
                this.setText('msgText', m);
                const i = document.getElementById('msgIcon');
                if(i) i.className = 'ph-fill ph-warning-circle text-alert'; 
                const mod = document.getElementById('msgModal');
                if(mod) {
                    mod.classList.remove('hidden');
                    mod.classList.add('flex');
                }
            },
            showSuccess(m) { 
                this.setText('msgText', m);
                const i = document.getElementById('msgIcon');
                if(i) i.className = 'ph-fill ph-check-circle text-money'; 
                const mod = document.getElementById('msgModal');
                if(mod) {
                    mod.classList.remove('hidden');
                    mod.classList.add('flex');
                }
            },
            closeMessageModal() { 
                this.closeModalById('msgModal');
            },

            openImportModal() { 
                const m = document.getElementById('importModal');
                if(m) {
                    m.classList.remove('hidden');
                    m.classList.add('flex');
                }
            },
            processImport() { 
                const ta = document.getElementById('importTextArea');
                const t = ta ? ta.value : ''; 
                if (!t) return; 
                const l = t.split('\n'); 
                let c = 0; 
                l.forEach(x => { const p = x.split(/[\t,]+/); if (p.length >= 4) { this.data.logs.push({ id: Date.now() + c, date: p[0], type: p[1], in: p[2], out: p[3], hours: this.calcHours(p[2], p[3]), disconnection: 0 }); c++; } }); 
                this.save(); 
                this.closeModalById('importModal'); 
                this.showSuccess(c + " importados"); 
            },
            
            importJson(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json.logs)) {
                            let count = 0;
                            json.logs.forEach(l => {
                                if (!this.data.logs.find(x => x.id === l.id)) {
                                    this.data.logs.push(l);
                                    count++;
                                }
                            });
                            if(json.config) this.data.config = { ...this.data.config, ...json.config };
                            
                            this.save();
                            this.render();
                            this.showSuccess(count > 0 ? `${count} registros recuperados` : "Datos actualizados");
                        } else {
                            this.showMessage("Archivo inválido");
                        }
                    } catch (err) {
                        this.showMessage("Error al leer JSON");
                    }
                    input.value = ''; 
                };
                reader.readAsText(file);
            },

            exportBackup() { const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(this.data)); a.download = 'backup.json'; a.click(); },

            calcHours(i, o) { if (!i || !o) return 0; const [h1, m1] = i.split(':'), [h2, m2] = o.split(':'); const d = ((h2 * 60 + +m2) - (h1 * 60 + +m1)); return d < 0 ? -1 : d; },
            toggleLoader(s) { 
                const l = document.getElementById('mainLoader');
                if(l) {
                    if(s) l.classList.remove('hidden'); else l.classList.add('hidden');
                }
            }
        };
        
        // --- EVENT LISTENER PARA LA EXTENSIÓN (GOD'S PLAN CONNECTOR) ---
        window.addEventListener("message", (event) => {
            if (event.data.type !== "GODSPLAN_COMMAND") return;
            console.log("Web God's Plan: Comando recibido del Content Script:", event.data.action);
            const action = event.data.action;
            switch(action) {
                case 'RESUME_WORK':
                    if (window.app.data.activeShift) {
                        window.app.stopBreak();
                    } else {
                        window.app.clockIn();
                    }
                    break;
                case 'START_BREAK_FOOD':
                    if (!window.app.data.activeShift) window.app.clockIn();
                    window.app.startBreak('food');
                    break;
                case 'START_BREAK_BATH':
                    if (!window.app.data.activeShift) window.app.clockIn();
                    window.app.startBreak('bathroom');
                    break;
                case 'END_SHIFT':
                    if (window.app.data.activeShift) window.app.finishShiftReal();
                    break;
                default:
                    console.log("Acción desconocida:", action);
            }
        });

        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
